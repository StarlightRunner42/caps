<!DOCTYPE html>
<html lang="en">
	<head>
		<title>ADMIN-PDAO</title>
		<!-- HTML5 Shim and Respond.js IE10 support of HTML5 elements and media queries -->
		<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
		<!--[if lt IE 10]>
		<script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
		<script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
		<![endif]-->
		<!-- Meta -->
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimal-ui">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="description" content="#">
		<meta name="keywords" content="Admin , Responsive, Landing, Bootstrap, App, Template, Mobile, iOS, Android, apple, creative app">
		<meta name="author" content="#">
		<!-- Favicon icon -->
		<link rel="icon" href="/assets/images/silay.png" type="image/x-icon">
		<!-- Google font-->
		<link href="https://fonts.googleapis.com/css?family=Open+Sans:400,600,800" rel="stylesheet">
		<!-- Required Fremwork -->
		<link rel="stylesheet" type="text/css" href="/bower_components/bootstrap/css/bootstrap.min.css">
		<!-- radial chart.css -->
		<link rel="stylesheet" href="/assets/pages/chart/radial/css/radial.css" type="text/css" media="all">
		<!-- feather Awesome -->
		<link rel="stylesheet" type="text/css" href="/assets/icon/feather/css/feather.css">
		<!-- Style.css -->
		<link rel="stylesheet" type="text/css" href="/assets/css/style.css">
		<link rel="stylesheet" type="text/css" href="/assets/css/analytics.css">
		<link rel="stylesheet" type="text/css" href="/assets/css/jquery.mCustomScrollbar.css">
	</head>
	<!-- Menu sidebar static layout -->
	<body>
		<!-- Pre-loader start -->
		<div class="theme-loader">
			<div class="ball-scale">
				<div class='contain'>
					<div class="ring">
						<div class="frame"></div>
					</div>
					<div class="ring">
						<div class="frame"></div>
					</div>
					<div class="ring">
						<div class="frame"></div>
					</div>
					<div class="ring">
						<div class="frame"></div>
					</div>
					<div class="ring">
						<div class="frame"></div>
					</div>
					<div class="ring">
						<div class="frame"></div>
					</div>
					<div class="ring">
						<div class="frame"></div>
					</div>
					<div class="ring">
						<div class="frame"></div>
					</div>
					<div class="ring">
						<div class="frame"></div>
					</div>
					<div class="ring">
						<div class="frame"></div>
					</div>
				</div>
			</div>
		</div>
		<!-- Pre-loader end -->
		<div id="pcoded" class="pcoded">
			<div class="pcoded-overlay-box"></div>
			<div class="pcoded-container navbar-wrapper">
				<nav class="navbar header-navbar pcoded-header">
					<div class="navbar-wrapper">
						<div class="navbar-logo">
							<a class="mobile-menu" id="mobile-collapse" href="#!">
								<i class="feather icon-menu"></i>
							</a>
							<a href="index-1.htm">
    <span class="logo-text">SILAY CITY</span>
</a>
							<a class="mobile-options">
								<i class="feather icon-more-horizontal"></i>
							</a>
						</div>
						<div class="navbar-container container-fluid">
							<ul class="nav-left">
								<li class="header-search">
									<div class="main-search morphsearch-search">
										<div class="input-group">
											<span class="input-group-addon search-close">
												<i class="feather icon-x"></i>
											</span>
											<input type="text" class="form-control">
											<span class="input-group-addon search-btn">
												<i class="feather icon-search"></i>
											</span>
										</div>
									</div>
								</li>
								<li>
									<a href="#!" onclick="javascript:toggleFullScreen()">
										<i class="feather icon-maximize full-screen"></i>
									</a>
								</li>
								<li>
									<a href="/Map" class="btn btn-primary rounded" id="addSeniorBtn" target="_blank">
										<i class="feather icon-user-plus"></i> View Map Pwd </a>
								</li>
							</ul>
							<ul class="nav-right">
								<li class="user-profile header-notification">
									<div class="dropdown-primary dropdown">
										<div class="dropdown-toggle" data-toggle="dropdown">
											
											<i class="feather icon-chevron-down"></i>
										</div>
										<ul class="show-notification profile-notification dropdown-menu" data-dropdown-in="fadeIn" data-dropdown-out="fadeOut">
											<li>
												<a href="/logout">
													<i class="feather icon-log-out"></i> Logout </a>
											</li>
										</ul>
									</div>
								</li>
							</ul>
						</div>
					</div>
				</nav>
				<!-- Sidebar inner chat end-->
				<div class="pcoded-main-container">
					<div class="pcoded-wrapper">
						<nav class="pcoded-navbar">
							<div class="pcoded-inner-navbar main-menu">
								<div class="pcoded-navigatio-lavel">Navigation</div>
								<ul class="pcoded-item pcoded-left-item">
									<li class="pcoded-hasmenu active pcoded-trigger">
										<a href="/dashboard">
											<span class="pcoded-micon">
												<i class="feather icon-home"></i>
											</span>
											<span class="pcoded-mtext">Dashboard</span>
										</a>
										<ul class="pcoded-submenu">
											<li class="active">
												<a href="/Index">
													<span class="">PDAO TABLE</span>
												</a>
											</li>
											<li class="">
												<a href="/Analytics">
													<span class="">OSCA TABLE</span>
												</a>
											</li>
										</ul>
									</li>
								</ul>
							</div>
						</nav>
						<div class="pcoded-content">
							<div class="pcoded-inner-content">
								<div class="main-body">
									<div class="page-wrapper">

										<div class="container">
											<div class="stats-overview">
												<div class="stat-card">
													<div class="stat-number" id="totalBarangays">16</div>
													<div class="stat-label">Total Barangays</div>
												</div>
												<div class="stat-card">
													<div class="stat-number" id="totalPDAO">2,198</div>
													<div class="stat-label">Total PDOA Count</div>
												</div>
												<div class="stat-card">
													<div class="stat-number" id="averagePDAO">137</div>
													<div class="stat-label">Average per Barangay</div>
												</div>
											</div>

											<div class="table-container">
												<div class="table-header">
													<h2 class="table-title">Barangay PDAO Table</h2>
													<div class="search-container">
														<input type="text" class="search-input" id="searchInput" placeholder="🔍 Search barangays...">
														<button id="generateReportBtn" class="btn btn-info" type="button" style="margin-left: 12px;">
															
															 Generate Report
														</button>
													</div>
												</div>

												<table class="data-table" id="dataTable">
													<thead>
														<tr>
															<th>Barangay Name</th>
															<th>PDAO Count</th>
															<th>Action</th>
														</tr>
													</thead>
													<tbody id="tableBody">
														<!-- Table rows will be generated here -->
													</tbody>
												</table>

												<div id="noResults" class="no-results" style="display: none;">
													<h3>🔍 No results found</h3>
													<p>Try adjusting your search terms</p>
												</div>
									
												<div class="pagination" id="pagination">
													<div class="pagination-info" id="paginationInfo">
														Showing 1-5 of 16 entries
													</div>
													<div class="pagination-controls" id="paginationControls">
														<!-- Pagination buttons will be generated here -->
													</div>
												</div>
											</div>
										</div>

										<!-- Enhanced Modal -->
										<div id="chartModal" class="modal">
											<div class="modal-content">
												<div class="modal-header">
													<span class="close">&times;</span>
													<h2 id="modalTitle">Barangay</h2>
												</div>
												
												<div class="chart-controls">
													<button class="chart-type-btn active" onclick="switchChartType('doughnut')">Donut Chart</button>
													<button class="chart-type-btn" onclick="switchChartType('table')">Table View</button>
												</div>
									
												<div id="chartContainer" class="chart-container">
													<canvas id="pieChart"></canvas>
												</div>
									
												<div id="tableContainer" class="table-view" style="display: none;">
													<table class="chart-table">
														<thead>
															<tr>
																<th>Category</th>
																<th>Percentage</th>
															</tr>
														</thead>
														<tbody id="chartTableBody">
															<!-- Table rows will be generated here -->
														</tbody>
													</table>
												</div>
									
												<div class="chart-info" id="chartInfo">
													<!-- Chart percentage info will be displayed here -->
												</div>
											</div>
										</div>
									

										
									<!-- latest activity end -->
								</div>
							</div>
						</div>
						<div id="styleSelector"></div>
					</div>
				</div>
			</div>
		</div>
		</div>
		</div>
		</div>
		<!-- Warning Section Starts -->
		<!-- Older IE warning message -->
		<!--[if lt IE 10]>
																	<div class="ie-warning">
																		<h1>Warning!!</h1>
																		<p>You are using an outdated version of Internet Explorer, please upgrade 
																			<br/>to any of the following web browsers to access this website.
																		</p>
																		<div class="iew-container">
																			<ul class="iew-download">
																				<li>
																					<a href="http://www.google.com/chrome/">
																						<img src="/assets/images/browser/chrome.png" alt="Chrome">
																							<div>Chrome</div>
																						</a>
																					</li>
																					<li>
																						<a href="https://www.mozilla.org/en-US/firefox/new/">
																							<img src="/assets/images/browser/firefox.png" alt="Firefox">
																								<div>Firefox</div>
																							</a>
																						</li>
																						<li>
																							<a href="http://www.opera.com">
																								<img src="/assets/images/browser/opera.png" alt="Opera">
																									<div>Opera</div>
																								</a>
																							</li>
																							<li>
																								<a href="https://www.apple.com/safari/">
																									<img src="/assets/images/browser/safari.png" alt="Safari">
																										<div>Safari</div>
																									</a>
																								</li>
																								<li>
																									<a href="http://windows.microsoft.com/en-us/internet-explorer/download-ie">
																										<img src="/assets/images/browser/ie.png" alt="">
																											<div>IE (9 & above)</div>
																										</a>
																									</li>
																								</ul>
																							</div>
																							<p>Sorry for the inconvenience!</p>
																						</div>
																						<![endif]-->
		<!-- Warning Section Ends -->
		<!-- Required Jquery -->
		<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
		<script type="text/javascript" src="/bower_components/jquery/js/jquery.min.js"></script>
		<script type="text/javascript" src="/bower_components/jquery-ui/js/jquery-ui.min.js"></script>
		<script type="text/javascript" src="/bower_components/popper.js/js/popper.min.js"></script>
		<script type="text/javascript" src="/bower_components/bootstrap/js/bootstrap.min.js"></script>
		<!-- jquery slimscroll js -->
		<script type="text/javascript" src="/bower_components/jquery-slimscroll/js/jquery.slimscroll.js"></script>
		<!-- modernizr js -->
		<script type="text/javascript" src="/bower_components/modernizr/js/modernizr.js"></script>
		<script type="text/javascript" src="/bower_components/modernizr/js/css-scrollbars.js"></script>
		<!-- Chart js -->
		<script type="text/javascript" src="/bower_components/chart.js/js/Chart.js"></script>
		<!-- Google map js -->
		<script src="https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/markerclusterer.js"></script>
		<script type="text/javascript" src="https://maps.google.com/maps/api/js?sensor=true"></script>
		<script type="text/javascript" src="/assets/pages/google-maps/gmaps.js"></script>
		<!-- gauge js -->
		<script src="/assets/pages/widget/gauge/gauge.min.js"></script>
		<script src="/assets/pages/widget/amchart/amcharts.js"></script>
		<script src="/assets/pages/widget/amchart/serial.js"></script>
		<script src="/assets/pages/widget/amchart/gauge.js"></script>
		<script src="/assets/pages/widget/amchart/pie.js"></script>
		<script src="/assets/pages/widget/amchart/light.js"></script>
		<!-- Custom js -->
		<script src="/assets/js/pcoded.min.js"></script>
		<script src="/assets/js/vartical-layout.min.js"></script>
		<script src="/assets/js/jquery.mCustomScrollbar.concat.min.js"></script>
		<script type="text/javascript" src="/assets/pages/dashboard/crm-dashboard.min.js"></script>
		<script type="text/javascript" src="/assets/js/script.js"></script>
		<script type="text/javascript" src="/assets/js/pdao.js"></script>
		<!-- Global site tag (gtag.js) - Google Analytics -->
		<script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-23581568-13"></script>
		<script>
			window.dataLayer = window.dataLayer || [];

			function gtag() {
				dataLayer.push(arguments);
			}
			gtag('js', new Date());
			gtag('config', 'UA-23581568-13');
		</script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/feather-icons/4.29.0/feather.min.js"></script>
		<script>
			// Initialize Feather Icons
			if (typeof feather !== 'undefined' && feather.replace) {
				try {
					feather.replace();
				} catch (e) {
					console.warn('feather.replace() failed:', e);
				}
			}

			// Generate Report functionality
			document.addEventListener('DOMContentLoaded', function() {
				console.log('DOM loaded - initializing Generate Report button');
				
				// Initialize Generate Report Button
				const generateReportBtn = document.getElementById('generateReportBtn');
				
				if (generateReportBtn) {
					console.log('Generate Report button found, adding event listener');
					
					generateReportBtn.addEventListener('click', async function() {
						console.log('Generate Report button clicked');
						
						try {
							// Fetch PWD data from the server
							const response = await fetch('/api/pwds', { credentials: 'same-origin' });
							if (!response.ok) {
								throw new Error('Failed to fetch PWD data');
							}
							const data = await response.json();
							const pwdsData = data.pwds || data.data || [];
							
							if (!pwdsData || pwdsData.length === 0) {
								alert('No PWD data available to generate report.');
								return;
							}
							
							// Build the report table HTML
							const tableHtml = buildPwdsReportTableHtml(pwdsData);
							
							// Open new window for report
							const newWin = window.open('', '_blank', 'width=1200,height=800,scrollbars=yes');
							
							if (!newWin) {
								alert('Popup blocked! Please allow popups for this site to view the report.');
								return;
							}
							
							const docHtml = `<!doctype html>
								<html>
								<head>
									<meta charset="utf-8">
									<title>PWD Disability Report</title>
									<meta name="viewport" content="width=device-width,initial-scale=1">
									<link rel="stylesheet" href="/bower_components/bootstrap/css/bootstrap.min.css">
									<style>
										body { padding: 20px; font-family: Arial, sans-serif; }
										.table { margin-top: 20px; }
										.summary { background: #f8f9fa; padding: 15px; border-radius: 5px; margin-top: 20px; }
									</style>
								</head>
								<body>
									<div class="container">
										<h2 class="my-3 text-center">PWD Disability Report</h2>
										<p class="text-center"><strong>Generated:</strong> ${new Date().toLocaleString()}</p>
										${tableHtml}
									</div>
								</body>
								</html>`;
							
							newWin.document.open();
							newWin.document.write(docHtml);
							newWin.document.close();
							
							console.log('Report generated successfully');
							
						} catch (e) {
							console.error('Error generating report:', e);
							alert('Error generating report: ' + e.message);
						}
					});
				} else {
					console.error('Generate Report button not found in DOM!');
				}

				// Build table HTML for report
				function buildPwdsReportTableHtml(pwds) {
					function esc(s){ 
						return String(s === null || s === undefined ? '' : s)
							.replace(/&/g,'&amp;')
							.replace(/</g,'&lt;')
							.replace(/>/g,'&gt;'); 
					}
					
					const mapping = {
						'Hard of Hearing/Deaf': 'Deaf or Hard of Hearing',
						'Visual/Blind': 'Visual Disability',
						'Speech/Language Impairment': 'Speech and Language Impairment',
						'Learning Disability': 'Learning Disability',
						'Mental/Intellectual': 'Intellectual Disability',
						'Physical Disability': 'Physical Disability (Orthopedic)',
						'Psychosocial Disability': 'Psychosocial Disability',
						'Cancer': 'Cancer (RA11215)',
						'Rare Disease': 'Rare Disease (RA10747)',
						'Multiple Disability': 'Multiple Disability',
						'Other': 'Other'
					};
					
					const stats = {};
					const uniqueIds = new Set();
					
					// Process PWD data
					pwds.forEach(p => {
						if (p && (p._id || p.id)) uniqueIds.add(p._id || p.id);
						const age = (typeof p.age === 'number') ? p.age : (p.age ? parseInt(p.age,10) : null);
						const gender = (p.gender || 'Unknown').toString();
						const disabilities = Array.isArray(p.disability) ? p.disability : (p.disability ? [p.disability] : []);
						
						disabilities.forEach(d => {
							const key = mapping[d] || d || 'Other';
							if (!stats[key]) {
								stats[key] = { 
									count: 0, 
									male: 0, 
									female: 0, 
									otherGender: 0, 
									ages: [] 
								};
							}
							stats[key].count += 1;
							if (age !== null && !isNaN(age)) stats[key].ages.push(age);
							if (/^male$/i.test(gender)) stats[key].male += 1;
							else if (/^female$/i.test(gender)) stats[key].female += 1;
							else stats[key].otherGender += 1;
						});
					});

					const preferredOrder = [
						'Deaf or Hard of Hearing', 'Intellectual Disability', 'Learning Disability', 
						'Mental Disability', 'Physical Disability (Orthopedic)', 'Psychosocial Disability', 
						'Speech and Language Impairment', 'Visual Disability', 'Cancer (RA11215)', 
						'Rare Disease (RA10747)', 'Multiple Disability', 'Other'
					];
					
					const keys = Array.from(new Set([...preferredOrder, ...Object.keys(stats)]));
					let html = `
						<div class="table-responsive">
							<table class="table table-striped table-bordered table-hover">
								<thead class="table-dark">
									<tr>
										<th>Disability Type</th>
										<th>Age Range</th>
										<th>Total</th>
										<th>Male</th>
										<th>Female</th>
										<th>Other/Unknown</th>
									</tr>
								</thead>
								<tbody>`;
					
					keys.forEach(k => {
						if (!stats[k]) return;
						const s = stats[k];
						const minAge = s.ages.length ? Math.min(...s.ages) : 'N/A';
						const maxAge = s.ages.length ? Math.max(...s.ages) : 'N/A';
						const ageRange = s.ages.length ? `${minAge} - ${maxAge}` : 'N/A';
						
						html += `
							<tr>
								<td><strong>${esc(k)}</strong></td>
								<td>${esc(ageRange)}</td>
								<td><span class="badge bg-primary">${s.count}</span></td>
								<td>${s.male}</td>
								<td>${s.female}</td>
								<td>${s.otherGender}</td>
							</tr>`;
					});
					
					html += '</tbody></table></div>';
					
					// Calculate totals
					let totalMale = 0, totalFemale = 0, totalOther = 0, totalCount = 0;
					Object.values(stats).forEach(s => { 
						totalMale += s.male; 
						totalFemale += s.female; 
						totalOther += s.otherGender;
						totalCount += s.count;
					});
					
					const allAges = [].concat(...Object.values(stats).map(s => s.ages));
					const overallAgeRange = allAges.length ? 
						`${Math.min(...allAges)} - ${Math.max(...allAges)}` : 'N/A';
					
					html += `
						<div class="summary">
							<h5>Report Summary</h5>
							<div class="row">
								<div class="col-md-6">
									<ul class="list-unstyled">
										<li><strong>Unique PWDs:</strong> ${uniqueIds.size}</li>
										<li><strong>Total Disability Records:</strong> ${totalCount}</li>
										<li><strong>Overall Age Range:</strong> ${overallAgeRange}</li>
									</ul>
								</div>
								<div class="col-md-6">
									<ul class="list-unstyled">
										<li><strong>Gender Distribution:</strong></li>
										<li>&nbsp;&nbsp;Male: ${totalMale}</li>
										<li>&nbsp;&nbsp;Female: ${totalFemale}</li>
										<li>&nbsp;&nbsp;Other/Unknown: ${totalOther}</li>
									</ul>
								</div>
							</div>
						</div>`;
					
					return html;
				}
			});
		</script>
	</body>
</html>