<!DOCTYPE html>
<html lang="en">
<head>
    <title>Senior Citizens</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimal-ui">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <!-- Favicon -->
    <link rel="icon" href="/assets/images/silay.png" type="image/x-icon">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:400,600,800" rel="stylesheet">
    <!-- CSS Frameworks -->
    <link rel="stylesheet" href="/bower_components/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="/assets/icon/feather/css/feather.css">
    <link rel="stylesheet" href="/assets/css/style.css">
    <link rel="stylesheet" href="/assets/css/pwd.css">
    <link rel="stylesheet" href="/assets/css/jquery.mCustomScrollbar.css">
    <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
    <style>
        .modal {
            z-index: 1050 !important;
        }
        .modal-backdrop {
            z-index: 1040 !important;
        }
        .modal-dialog {
            z-index: 1055 !important;
        }
        .action-container {
            display: flex;
            gap: 5px;
        }
        .action {
            padding: 5px 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .action-primary {
            background-color: #007bff;
            color: white;
        }
        .action-success {
            background-color: #28a745;
            color: white;
        }
        .action:hover {
            opacity: 0.8;
        }
        .action svg {
            width: 16px;
            height: 16px;
        }
        .action-archive {
            background: linear-gradient(135deg, #ed8936, #f6ad55);
            color: white;
        }
        .action-archive:hover {
            background: linear-gradient(135deg, #dd6b20, #ed8936);
            box-shadow: 0 8px 25px rgba(237, 137, 54, 0.3);
        }
        .action-archive[data-status="Archived"] {
            background: linear-gradient(135deg, #4a5568, #718096);
        }
        .action-archive[data-status="Archived"]:hover {
            background: linear-gradient(135deg, #2d3748, #4a5568);
            box-shadow: 0 8px 25px rgba(74, 85, 104, 0.3);
        }
    </style>
</head>
<body>
    <!-- Pre-loader start -->
    <div class="theme-loader">
        <div class="ball-scale">
            <div class='contain'>
                <div class="ring">
                    <div class="frame"></div>
                </div>
                <div class="ring">
                    <div class="frame"></div>
                </div>
                <div class="ring">
                    <div class="frame"></div>
                </div>
                <div class="ring">
                    <div class="frame"></div>
                </div>
                <div class="ring">
                    <div class="frame"></div>
                </div>
                <div class="ring">
                    <div class="frame"></div>
                </div>
                <div class="ring">
                    <div class="frame"></div>
                </div>
                <div class="ring">
                    <div class="frame"></div>
                </div>
                <div class="ring">
                    <div class="frame"></div>
                </div>
                <div class="ring">
                    <div class="frame"></div>
                </div>
            </div>
        </div>
    </div>
    <!-- Pre-loader end -->
    <div id="pcoded" class="pcoded">
        <div class="pcoded-overlay-box"></div>
        <div class="pcoded-container navbar-wrapper">
            <nav class="navbar header-navbar pcoded-header">
                <div class="navbar-wrapper">
                    <div class="navbar-logo">
                        <a class="mobile-menu" id="mobile-collapse" href="#!">
                            <i class="feather icon-menu"></i>
                        </a>
                        <a href="index-1.htm">
    <span class="logo-text">SILAY CITY</span>
</a>
                        <a class="mobile-options">
                            <i class="feather icon-more-horizontal"></i>
                        </a>
                    </div>
                    <div class="navbar-container container-fluid">
                        <ul class="nav-left">
                            <li class="header-search">
                                <div class="main-search morphsearch-search">
                                    <div class="input-group">
                                        <span class="input-group-addon search-close">
                                            <i class="feather icon-x"></i>
                                        </span>
                                        <input type="text" class="form-control" placeholder="Search...">
                                        <span class="input-group-addon search-btn">
                                            <i class="feather icon-search"></i>
                                        </span>
                                    </div>
                                </div>
                            </li>
                            <li>
                                <a href="#!" onclick="javascript:toggleFullScreen()">
                                    <i class="feather icon-maximize full-screen"></i>
                                </a>
                            </li>
                            <li>
                                <a href="/add_senior" class="btn btn-primary rounded" id="addSeniorBtn" target="_blank">
                                    <i class="feather icon-user-plus"></i>ADD SENIOR </a>
                            </li>
                        </ul>
                        <ul class="nav-right"></ul>
                        <ul class="nav-right">
                            <li class="user-profile header-notification">
                                <div class="dropdown-primary dropdown">
                                    <div class="dropdown-toggle" data-toggle="dropdown">
                                        <i class="feather icon-chevron-down"></i>
                                    </div>
                                    <ul class="show-notification profile-notification dropdown-menu" data-dropdown-in="fadeIn" data-dropdown-out="fadeOut">
            
                                        <li>
                                            <a href="/logout">
                                                <i class="feather icon-log-out"></i> Logout </a>
                                        </li>
                                    </ul>
                                </div>
                            </li>
                        </ul>
                    </div>
                </div>
            </nav>
            <div class="pcoded-main-container">
                <div class="pcoded-wrapper">
                    <nav class="pcoded-navbar">
                        <div class="pcoded-inner-navbar main-menu">
                            <div class="pcoded-navigatio-lavel">Navigation</div>
                            <ul class="pcoded-item pcoded-left-item">
                                <li class="pcoded-hasmenu active pcoded-trigger">
                                    <a href="javascript:void(0)">
                                        <span class="pcoded-micon">
                                            <i class="feather icon-home"></i>
                                        </span>
                                        <span class="pcoded-mtext">Dashboard</span>
                                    </a>
                                    <ul class="pcoded-submenu">
                                        <li class="">
                                            <a href="/Pwd-form">
                                                <span class="">PDAO</span>
                                            </a>
                                        </li>
                                        <li class="active">
                                            <a href="/Senior-form">
                                                <span class="">OSCA</span>
                                            </a>
                                        </li>
                                    </ul>
                                </li>
                            </ul>
                        </div>
                    </nav>
                    <div class="pcoded-content">
                        <div class="pcoded-inner-content">
                            <div class="main-body">
                                <div class="page-wrapper">

                                    <div class="container">
                                        <h1>SENIOR CITIZENS</h1>
                                        <div class="filter-container">
                                            <div class="filter-group">
                                                <label for="barangay-filter">Barangay:</label>
                                                <select id="barangay-filter" class="form-control">
                                                    <option value="">All Barangays</option>
                                                    <% Object.keys(barangays).forEach(barangay => { %>
                                                        <option value="<%= barangay %>"><%= barangay %></option>
                                                    <% }) %>
                                                </select>
                                            </div>
                                            <div class="filter-group">
                                                <label for="purok-filter">Purok:</label>
                                                <select id="purok-filter" class="form-control" disabled>
                                                    <option value="">First select a Barangay</option>
                                                </select>
                                            </div>
                                            <!-- Status Filter -->
                                            <div class="filter-group" style="margin-left: 12px;">
                                                <label for="status-filter">Status:</label>
                                                <select id="status-filter" class="form-control">
                                                    <option value="active">Active Only</option>
                                                    <option value="archived">Archived Only</option>
                                                    <option value="all">All Records</option>
                                                </select>
                                            </div>
                                            <!-- Generate Report Button -->
                                            <div class="filter-group" style="margin-left: 12px;">
                                                <label>&nbsp;</label>
                                                <button id="generateReportBtn" class="btn btn-info" type="button">
                                                     Generate Report
                                                </button>
                                            </div>
                                        </div>
                                        
                                        <% if (seniorCitizens && seniorCitizens.length > 0) { %>
                                            <!-- Report Modal -->
                                            <div class="modal fade" id="reportModal" tabindex="-1" aria-labelledby="reportModalLabel" aria-hidden="true">
                                                <div class="modal-dialog modal-dialog-centered modal-lg">
                                                    <div class="modal-content">
                                                        <div class="modal-header">
                                                            <h5 class="modal-title" id="reportModalLabel">Senior Citizens Report</h5>
                                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                        </div>
                                                        <div class="modal-body">
                                                            <div id="reportContent" style="white-space:pre-wrap; font-family: monospace;"></div>
                                                        </div>
                                                        <div class="modal-footer">
                                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                                            <button id="copyReportBtn" type="button" class="btn btn-outline-primary">Copy</button>
                                                            <a id="downloadReportLink" class="btn btn-primary" download="senior_citizens_report.txt">Download</a>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        
                                            <table id="example" class="display" style="width:100%">
                                                <thead>
                                                    <tr>
                                                        <th>
                                                            <input type="checkbox" id="select-all" aria-label="Select all rows">
                                                        </th>
                                                        <th>Full Name</th>
                                                        <th>Age</th>
                                                        <th>Barangay</th>
                                                        <th>Purok</th>
                                                        <th>Civil Status</th>
                                                        <th>Status</th>
                                                        <th>Actions</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <% seniorCitizens.forEach(senior => { %>
                                                        <tr>
                                                            <td>
                                                                <input type="checkbox" class="row-checkbox" value="<%= senior._id || senior.id %>" aria-label="Select row"
                                                                    data-phone="<%= (senior.identifying_information.contacts && senior.identifying_information.contacts.length && senior.identifying_information.contacts[0].phone) ? senior.identifying_information.contacts[0].phone : '' %>"
                                                                    data-name="<%= senior.identifying_information.name.first_name + ' ' + senior.identifying_information.name.last_name %>"
                                                                    data-first-name="<%= senior.identifying_information.name.first_name || '' %>"
                                                                    data-middle-name="<%= senior.identifying_information.name.middle_name || '' %>"
                                                                    data-last-name="<%= senior.identifying_information.name.last_name || '' %>"
                                                                    data-barangay="<%= senior.identifying_information.address.barangay || '' %>"
                                                                    data-purok="<%= senior.identifying_information.address.purok || '' %>"
                                                                    data-record-id="<%= senior._id || senior.id %>">
                                                            </td>
                                                            <td>
                                                                <%= senior.identifying_information.name.last_name %>
                                                                <%= senior.identifying_information.name.first_name %> 
                                                                <%= senior.identifying_information.name.middle_name || '' %>
                                                            </td>
                                                            <td><%= senior.identifying_information.age %></td>
                                                            <td><%= senior.identifying_information.address.barangay %></td>
                                                            <td><%= senior.identifying_information.address.purok %></td>
                                                            <td><%= senior.identifying_information.marital_status %></td>
                                                            <td>
                                                                <span class="badge <%= (senior.status === 'Archived') ? 'badge-secondary' : 'badge-success' %>">
                                                                    <%= senior.status || 'Active' %>
                                                                </span>
                                                            </td>
                                                            <td>
                                                                <div class="action-container">
                                                                    <button class="action view-btn" 
                                                                            aria-label="View" 
                                                                            data-toggle="modal" data-target="#viewModal"
                                                                            data-senior='<%= JSON.stringify(senior).replace(/'/g, "&apos;") %>'>
                                                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                                                        </svg>
                                                                    </button>
                                                                    <button class="action action-edit edit-btn" 
                                                                            aria-label="Edit" 
                                                                            data-toggle="modal" data-target="#editModal"
                                                                            data-senior='<%= JSON.stringify(senior).replace(/'/g, "&apos;") %>'>
                                                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                                                        </svg>
                                                                    </button>
                                                                    <button class="action action-archive archive-btn" aria-label="Archive" 
                                                                        data-senior-id="<%= senior._id || senior.id %>"
                                                                        data-status="<%= senior.status || 'Active' %>"
                                                                        title="<%= (senior.status === 'Archived') ? 'Unarchive' : 'Archive' %>">
                                                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" />
                                                                        </svg>
                                                                    </button>
                                                                </div>
                                                            </td>
                                                        </tr>
                                                    <% }); %>
                                                </tbody>
                                            </table>
                                            <!-- Button to open SMS modal for selected rows -->
                                            <div class="mt-3">
                                                <button id="openSmsForSelected" class="btn btn-success" disabled>
                                                    <i data-feather="message-circle"></i> Send SMS to selected
                                                </button>
                                                <button id="viewSmsHistoryBtn" class="btn btn-info ml-2">
                                                    <i data-feather="clock"></i> View SMS History
                                                </button>
                                            </div>

                                            <!-- SMS Modal -->
                                            <div class="modal fade" id="assistanceModal" tabindex="-1" aria-labelledby="assistanceModalLabel" aria-hidden="true">
                                                <div class="modal-dialog modal-dialog-centered">
                                                    <div class="modal-content">
                                                        <div class="modal-header">
                                                            <h5 class="modal-title" id="assistanceModalLabel">
                                                                <i data-feather="send" style="width: 20px; height: 20px;"></i> Send SMS Assistance
                                                            </h5>
                                                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                                <span aria-hidden="true">&times;</span>
                                                            </button>
                                                        </div>
                                                        <div class="modal-body">
                                                            <form id="smsForm">

                                                                <div class="mb-2">
                                                                    <label class="form-label">Recipients</label>
                                                                    <div id="recipientsList" style="max-height:150px; overflow:auto; border:1px solid #e9ecef; padding:8px; border-radius:4px;">
                                                                        <!-- Filled dynamically with selected recipients -->
                                                                        <em>No recipients selected</em>
                                                                    </div>
                                                                </div>

                                                                <div class="sms-template">
                                                                    <label class="form-label">
                                                                        <i data-feather="message-square" style="width: 16px; height: 16px;"></i> Message Template
                                                                    </label>
                                                                    <textarea class="form-control" id="smsMessage" rows="6" required>Hello!You are eligible for PWD benefits Visit your local office to claim.Thank you!</textarea>
                                                                    <small class="text-muted">You can edit this message before sending</small>
                                                                </div>

                                                        <!-- Character Counter -->
                                                        <div class="mb-3">
                                                            <small class="text-muted">
                                                                Characters: <span id="charCount">0</span>/160
                                                            </small>
                                                        </div>
                                                            </form>
                                                        </div>
                                                        <div class="modal-footer">
                                                            <button type="button" class="btn btn-secondary" data-dismiss="modal">
                                                                <i data-feather="x" style="width: 16px; height: 16px;"></i> Cancel
                                                            </button>
                                                            <button type="button" class="btn btn-primary btn-send" id="sendSmsBtn">
                                                                <i data-feather="send" style="width: 16px; height: 16px;"></i> Send SMS
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- SMS History Modal -->
                                            <div class="modal fade" id="smsHistoryModal" tabindex="-1" aria-labelledby="smsHistoryModalLabel" aria-hidden="true">
                                                <div class="modal-dialog modal-dialog-centered modal-xl">
                                                    <div class="modal-content">
                                                        <div class="modal-header">
                                                            <h5 class="modal-title" id="smsHistoryModalLabel">
                                                                <i data-feather="clock"></i> SMS History
                                                            </h5>
                                                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                                <span aria-hidden="true">&times;</span>
                                                            </button>
                                                        </div>
                                                        <div class="modal-body">
                                                            <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                                                                <table class="table table-striped table-bordered table-hover">
                                                                    <thead class="table-dark" style="position: sticky; top: 0; z-index: 10;">
                                                                        <tr>
                                                                            <th>Date & Time</th>
                                                                            <th>Phone Number</th>
                                                                            <th>Name</th>
                                                                            <th>Barangay</th>
                                                                            <th>Purok</th>
                                                                            <th>Message</th>
                                                                            <th>Status</th>
                                                                        </tr>
                                                                    </thead>
                                                                    <tbody id="smsHistoryTableBody">
                                                                        <tr>
                                                                            <td colspan="7" class="text-center">Loading...</td>
                                                                        </tr>
                                                                    </tbody>
                                                                </table>
                                                            </div>
                                                        </div>
                                                        <div class="modal-footer">
                                                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        <% } else { %>
                                            <div class="alert alert-info text-center">No senior citizens found.</div>
                                        <% } %>
                                    </div>
                                    
                                   <!-- View Modal -->
<div class="modal fade" id="viewModal" tabindex="-1" role="dialog" aria-labelledby="viewModalTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewModalTitle">
                    <span id="displayLastName"></span>, 
                    <span id="displayFirstName"></span> 
                    <span id="displayMiddleName"></span>
                </h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            
            <div class="modal-body">
                <!-- Top Row: Personal Information + Contact Information -->
                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                    <!-- Left - Personal Information -->
                    <fieldset class="compact-spacing">
                        <legend>PERSONAL INFORMATION</legend>
                        <p class="compact-spacing">
                            <strong>Address:</strong> 
                            <span id="displayBarangay"></span>, 
                            <span id="displayPurok"></span>
                        </p>
                        <p class="compact-spacing">
                            <strong>Birthday:</strong> 
                            <span id="displayBirthday"></span> 
                            (<span id="displayAge"></span> years old)
                        </p>
                        <p class="compact-spacing">
                            <strong>Gender:</strong> 
                            <span id="displayGender"></span>
                        </p>
                        <p class="compact-spacing">
                            <strong>Marital Status:</strong> 
                            <span id="displayCivilStatus"></span>
                        </p>
                        <p class="compact-spacing">
                            <strong>Place of Birth:</strong> 
                            <span id="displayPlaceOfBirth"></span>
                        </p>
                        <p id="displaySpouse" class="compact-spacing" style="display:none;">
                            <strong>Spouse:</strong> 
                            <span id="displaySpouseName"></span>
                        </p>
                        <p class="compact-spacing">
                            <strong>Father:</strong> 
                            <span id="displayFatherName"></span>
                        </p>
                        <p class="no-bottom-margin">
                            <strong>Mother:</strong> 
                            <span id="displayMotherName"></span>
                        </p>
                    </fieldset>
                    
                    <!-- Right - Contact Information -->
                    <fieldset class="compact-spacing">
                        <legend>CONTACT INFORMATION</legend>
                        <div id="displayContacts">
                            <!-- Contact information will be dynamically inserted here -->
                        </div>
                    </fieldset>
                </div>

                <!-- Middle Row: ID Information + Education & Skills -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                    <!-- Left - ID Information -->
                    <fieldset class="compact-spacing">
                        <legend>ID INFORMATION</legend>
                        <p class="compact-spacing">
                            <strong>OSCA ID:</strong> 
                            <span id="displayOscaId"></span>
                        </p>
                        <p class="compact-spacing">
                            <strong>GSIS/SSS:</strong> 
                            <span id="displayGsisSss"></span>
                        </p>
                        <p class="compact-spacing">
                            <strong>Philhealth:</strong> 
                            <span id="displayPhilhealth"></span>
                        </p>
                        <p class="compact-spacing">
                            <strong>TIN:</strong> 
                            <span id="displayTin"></span>
                        </p>
                        <p class="no-bottom-margin">
                            <strong>Other Govt ID:</strong> 
                            <span id="displayOtherGovtId"></span>
                        </p>
                    </fieldset>
                    
                    <!-- Right - Education & Skills -->
                    <fieldset class="compact-spacing">
                        <legend>EDUCATION & SKILLS</legend>
                        <p class="compact-spacing">
                            <strong>Education:</strong> 
                            <span id="displayEducation"></span>
                        </p>
                        <p class="no-bottom-margin">
                            <strong>Skills:</strong> 
                            <span id="displaySkills"></span>
                        </p>
                    </fieldset>
                </div>

                <!-- Bottom Row: Family Composition + Community Service -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <!-- Left - Family Composition -->
                    <fieldset class="compact-spacing">
                        <legend>FAMILY COMPOSITION</legend>
                        <div id="displayChildren">
                            <!-- Family composition will be dynamically inserted here -->
                        </div>
                    </fieldset>

                    <!-- Right - Community Service -->
                    <fieldset class="compact-spacing">
                        <legend>COMMUNITY SERVICE</legend>
                        <div id="displayCommunityService">
                            <!-- Community service will be dynamically inserted here -->
                        </div>
                    </fieldset>
                </div>
                
                <!-- Edit Log Information -->
                <fieldset class="no-bottom-margin" style="margin-top: 1rem;">
                    <legend>EDIT HISTORY</legend>
                    <div id="displayEditLog">
                        <p class="compact-spacing">
                            <strong>Last Edited By:</strong>
                            <span id="displayEditedBy">N/A</span>
                        </p>
                        <p class="no-bottom-margin">
                            <strong>Last Edited At:</strong>
                            <span id="displayEditedAt">N/A</span>
                        </p>
                    </div>
                </fieldset>
            </div>
            
            <div class="modal-footer flex-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                
            </div>
        </div>
    </div>
</div>


<!-- Edit Modal -->
<div class="modal fade" id="editModal" tabindex="-1" role="dialog" aria-labelledby="editModalTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editModalTitle">Edit Senior Citizen Information</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>

            <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                <form id="editResidentForm">
                    <input type="hidden" id="editResidentId" name="residentId">
                    
                    <!-- Personal Information -->
                    <fieldset class="mb-4">
                        <legend>PERSONAL INFORMATION</legend>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="editFirstName">First Name</label>
                                    <input type="text" class="form-control" id="editFirstName" name="first_name" required>
                        </div>
                </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="editMiddleName">Middle Name</label>
                                    <input type="text" class="form-control" id="editMiddleName" name="middle_name">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="editLastName">Last Name</label>
                                    <input type="text" class="form-control" id="editLastName" name="last_name" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="editBarangay">Barangay</label>
                                    <select class="form-control" id="editBarangay" name="barangay" required>
                                        <option value="">Select Barangay</option>
                                        <% Object.keys(barangays).forEach(barangay => { %>
                                            <option value="<%= barangay %>"><%= barangay %></option>
                                        <% }) %>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="editPurok">Purok</label>
                                    <select class="form-control" id="editPurok" name="purok" required>
                                        <option value="">Select Purok</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="editGender">Gender</label>
                                    <select class="form-control" id="editGender" name="gender" required>
                                        <option value="">Select Gender</option>
                                        <option value="Male">Male</option>
                                        <option value="Female">Female</option>
                                        <option value="Other">Other</option>
                                        <option value="Prefer not to say">Prefer not to say</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="editBirthday">Birthday</label>
                                    <input type="date" class="form-control" id="editBirthday" name="birthday" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="editAge">Age</label>
                                    <input type="number" class="form-control" id="editAge" name="age" readonly>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="editMaritalStatus">Marital Status</label>
                                    <select class="form-control" id="editMaritalStatus" name="marital_status" required>
                                        <option value="">Select Status</option>
                                        <option value="Single">Single</option>
                                        <option value="Married">Married</option>
                                        <option value="Widowed">Widowed</option>
                                        <option value="Divorced">Divorced</option>
                                        <option value="Separated">Separated</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="editPlaceOfBirth">Place of Birth</label>
                                    <input type="text" class="form-control" id="editPlaceOfBirth" name="place_of_birth">
                                </div>
                            </div>
                            <div class="col-md-6" id="editSpouseGroup" style="display: none;">
                                <div class="form-group">
                                    <label for="editSpouseName">Spouse Name</label>
                                    <input type="text" class="form-control" id="editSpouseName" name="spouse_name">
                                </div>
                            </div>
                        </div>
                    </fieldset>

                    <!-- ID Information -->
                    <fieldset class="mb-4">
                        <legend>ID INFORMATION</legend>
                        <div class="row">
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="editOscaId">OSCA ID</label>
                                    <input type="text" class="form-control" id="editOscaId" name="osca_id">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="editGsisSss">GSIS/SSS</label>
                                    <input type="text" class="form-control" id="editGsisSss" name="gsis_sss">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="editPhilhealth">Philhealth</label>
                                    <input type="text" class="form-control" id="editPhilhealth" name="philhealth">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="editTin">TIN</label>
                                    <input type="text" class="form-control" id="editTin" name="tin">
                                </div>
                            </div>
                        </div>
                    </fieldset>
                    
                    <!-- Family Information -->
                    <fieldset class="mb-4">
                        <legend>FAMILY INFORMATION</legend>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="editFatherName">Father's Name</label>
                                    <input type="text" class="form-control" id="editFatherName" name="father_name">
                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="editMotherName">Mother's Name</label>
                                    <input type="text" class="form-control" id="editMotherName" name="mother_name">
                                </div>
                </div>
                        </div>
                    </fieldset>

                    <!-- Contact Information -->
                    <fieldset class="mb-4">
                        <legend>CONTACT INFORMATION</legend>
                        <div id="editContactsContainer">
                            <!-- Dynamic contact fields will be added here -->
                        </div>
                        <button type="button" class="btn btn-sm btn-secondary" id="addEditContact">+ Add Contact</button>
                    </fieldset>
                </form>
                    </div>
                    
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="updateBtn">Update Information</button>
            </div>
        </div>
    </div>
</div>


                                   
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Convert EJS data to JavaScript object
        const barangaysData = <%- JSON.stringify(barangays) %>;
        const seniorCitizensData = <%- JSON.stringify(seniorCitizens) %>;
        
        // Wait for DOM to be fully loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize Generate Report Button
            const generateReportBtn = document.getElementById('generateReportBtn');
            
            if (generateReportBtn) {
                generateReportBtn.addEventListener('click', function() {
                    try {
                        // Build the report table HTML
                        const tableHtml = buildSeniorCitizensReportTableHtml(seniorCitizensData);
                        
                        // Open new window for report
                        const newWin = window.open('', '_blank', 'width=1200,height=800,scrollbars=yes');
                        
                        if (!newWin) {
                            alert('Popup blocked! Please allow popups for this site to view the report.');
                            return;
                        }
                        
                        const docHtml = `<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>Senior Citizens Report</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <link rel="stylesheet" href="/bower_components/bootstrap/css/bootstrap.min.css">
    <style>
        body { padding: 30px; font-family: Arial, sans-serif; }

        .header-wrapper {
            position: relative;
            margin-bottom: 20px;
            min-height: 130px;
        }

        .logo-left {
            position: absolute;
            top: 0;
            left: 0;
            width: 95px;
        }

        .logo-right {
            position: absolute;
            top: 0;
            right: 0;
            width: 120px;
        }

        .main-header {
            text-align: center;
            margin-top: 15px;
        }

        .title-section { 
            margin-top: 15px; 
            text-align: center;
        }

        .report-info {
            margin: 20px auto;
            text-align: center;
            font-size: 13px;
            line-height: 1.8;
            max-width: 800px;
            white-space: nowrap;
        }

        .info-item {
            display: inline-block;
            margin: 0 15px;
        }

        .underline {
            display: inline-block;
            border-bottom: 1px solid #000;
            width: 120px;
            height: 14px;
            vertical-align: bottom;
            margin-left: 5px;
        }

        .address-underline {
            width: 150px;
        }

        .generated-date {
            margin-top: 10px;
            font-style: italic;
        }
    </style>
</head>

<body>

<div class="container">
    <div class="text-center generated-date">
        <p><strong>Generated:</strong> ${new Date().toLocaleString()}</p>
    </div>
    
    <div class="header-wrapper">
        <img src="/assets/images/SilayLogo.jpg" class="logo-left">
        <img src="/assets/images/BagongPilipinas.jpg" class="logo-right">

        <div class="main-header">
            <h4>Republic of the Philippines</h4>
            <h2><strong>SILAY CITY GOVERNMENT</strong></h2>
            <p>Office of Senior Citizens Affairs</p>
        </div>
    </div>

    <div class="title-section">
        <h5>OFFICE OF SENIOR CITIZENS AFFAIRS</h5>
        <h5>ANNUAL ACCOMPLISHMENT REPORT</h5>
    </div>

    <div class="report-info">
        <span class="info-item">Region: <span class="underline"></span></span>
        <span class="info-item">Senior Citizens Statistics: <span class="underline"></span></span>
        <span class="info-item">Address: <span class="underline address-underline"></span></span>
    </div>

    ${tableHtml}

</div>

</body>
</html>`;
                        
                        newWin.document.open();
                        newWin.document.write(docHtml);
                        newWin.document.close();
                        
                        console.log('Report generated successfully');
                        
                    } catch (e) {
                        console.error('Error generating report:', e);
                        alert('Error generating report: ' + e.message);
                    }
                });
            }

            // Build table HTML for report
            function buildSeniorCitizensReportTableHtml(seniors) {
                function esc(s){ 
                    return String(s === null || s === undefined ? '' : s)
                        .replace(/&/g,'&amp;')
                        .replace(/</g,'&lt;')
                        .replace(/>/g,'&gt;'); 
                }
                
                // Group seniors by barangay and count by gender
                const barangayStats = {};
                
                seniors.forEach(senior => {
                    const barangay = senior.identifying_information?.address?.barangay || 'Unknown';
                    const gender = (senior.identifying_information?.gender || 'Unknown').toString().toLowerCase();
                    
                    if (!barangayStats[barangay]) {
                        barangayStats[barangay] = {
                            male: 0,
                            female: 0,
                            total: 0
                        };
                    }
                    
                    if (gender === 'male') {
                        barangayStats[barangay].male++;
                    } else if (gender === 'female') {
                        barangayStats[barangay].female++;
                    }
                    
                    barangayStats[barangay].total++;
                });
                
                // Sort barangays alphabetically
                const sortedBarangays = Object.keys(barangayStats).sort();
                
                // Build table HTML
                let html = `
                    <div class="table-responsive">
                        <table class="table table-striped table-bordered table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Barangay</th>
                                    <th>Male</th>
                                    <th>Female</th>
                                    <th>Total of Citizens</th>
                                </tr>
                            </thead>
                            <tbody>`;
                
                let grandTotalMale = 0;
                let grandTotalFemale = 0;
                let grandTotal = 0;
                
                sortedBarangays.forEach(barangay => {
                    const stats = barangayStats[barangay];
                    grandTotalMale += stats.male;
                    grandTotalFemale += stats.female;
                    grandTotal += stats.total;
                    
                    html += `
                        <tr>
                            <td><strong>${esc(barangay)}</strong></td>
                            <td>${stats.male}</td>
                            <td>${stats.female}</td>
                            <td><span class="badge bg-primary">${stats.total}</span></td>
                        </tr>`;
                });
                
                // Add total row
                html += `
                            </tbody>
                            <tfoot class="table-dark">
                                <tr>
                                    <td><strong>TOTAL</strong></td>
                                    <td><strong>${grandTotalMale}</strong></td>
                                    <td><strong>${grandTotalFemale}</strong></td>
                                    <td><strong><span class="badge bg-success">${grandTotal}</span></strong></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>`;
                
                // Add summary
                html += `
                    <div class="summary" style="margin-top: 20px;">
                        <hr>
                        <h5>Report Summary</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <ul class="list-unstyled">
                                    <li><strong>Total Senior Citizens:</strong> ${grandTotal}</li>
                                    <li><strong>Total Male:</strong> ${grandTotalMale}</li>
                                    <li><strong>Total Female:</strong> ${grandTotalFemale}</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <ul class="list-unstyled">
                                    <li><strong>Number of Barangays:</strong> ${sortedBarangays.length}</li>
                                </ul>
                            </div>
                        </div>
                    </div>`;
                
                return html;
            }
            
            // Get select elements
            const barangaySelect = document.getElementById('barangay-filter');
            const purokSelect = document.getElementById('purok-filter');
            const statusFilter = document.getElementById('status-filter');
            
            // Set initial status filter value based on URL parameter
            const urlParams = new URLSearchParams(window.location.search);
            const statusParam = urlParams.get('status');
            if (statusParam === 'all') {
                statusFilter.value = 'all';
            } else if (statusParam === 'archived') {
                statusFilter.value = 'archived';
            } else {
                statusFilter.value = 'active';
            }
            
            // Status filter change event handler
            statusFilter.addEventListener('change', function() {
                const selectedStatus = this.value;
                const url = new URL(window.location.href);
                
                if (selectedStatus === 'active') {
                    url.searchParams.delete('status');
                } else if (selectedStatus === 'archived') {
                    url.searchParams.set('status', 'archived');
                } else {
                    url.searchParams.set('status', 'all');
                }
                
                window.location.href = url.toString();
            });
            
            // Initialize purok dropdown as disabled
            purokSelect.disabled = true;

            // Barangay change event handler
            barangaySelect.addEventListener('change', function() {
                const selectedBarangay = this.value;
                purokSelect.innerHTML = '';
                
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = 'Select Purok';
                purokSelect.appendChild(defaultOption);
                
                purokSelect.disabled = !selectedBarangay;
                
                if (selectedBarangay && barangaysData[selectedBarangay]) {
                    const allOption = document.createElement('option');
                    allOption.value = 'all';
                    allOption.textContent = 'All Puroks';
                    purokSelect.appendChild(allOption);
                    
                    barangaysData[selectedBarangay].forEach(purok => {
                        const option = document.createElement('option');
                        option.value = purok;
                        option.textContent = purok;
                        purokSelect.appendChild(option);
                    });
                }
            });

            // Senior Citizen View Modal Handler - using event delegation
            document.addEventListener('click', function(e) {
                if (e.target.closest('.view-btn')) {
                    const button = e.target.closest('.view-btn');
                    try {
                        const seniorData = JSON.parse(button.getAttribute('data-senior'));
                        console.log('Senior Data:', seniorData);
                        
                        // Name Information
                        const name = seniorData.identifying_information?.name || {};
                        document.getElementById('displayFirstName').textContent = name.first_name || 'N/A';
                        document.getElementById('displayMiddleName').textContent = name.middle_name || '';
                        document.getElementById('displayLastName').textContent = name.last_name || 'N/A';
                        if (name.extension) {
                            document.getElementById('displayLastName').textContent += ` ${name.extension}`;
                        }
                        
                        // Address Information
                        const address = seniorData.identifying_information?.address || {};
                        document.getElementById('displayBarangay').textContent = address.barangay || 'N/A';
                        document.getElementById('displayPurok').textContent = address.purok || 'N/A';
                        
                        // Personal Information
                        const dob = seniorData.identifying_information?.date_of_birth;
                        document.getElementById('displayBirthday').textContent = dob ? new Date(dob).toLocaleDateString() : 'N/A';
                        document.getElementById('displayAge').textContent = seniorData.identifying_information?.age || 'N/A';
                        document.getElementById('displayGender').textContent = seniorData.identifying_information?.gender || 'N/A';
                        document.getElementById('displayCivilStatus').textContent = seniorData.identifying_information?.marital_status || 'N/A';
                        document.getElementById('displayPlaceOfBirth').textContent = 
                            Array.isArray(seniorData.identifying_information?.place_of_birth) ? 
                            seniorData.identifying_information.place_of_birth.join(', ') : 
                            'N/A';
                        
                        // Spouse Information
                        if (seniorData.family_composition?.spouse?.name) {
                            document.getElementById('displaySpouse').style.display = 'block';
                            document.getElementById('displaySpouseName').textContent = seniorData.family_composition.spouse.name;
                        } else {
                            document.getElementById('displaySpouse').style.display = 'none';
                        }
                        
                        // Parent Information
                        const father = seniorData.family_composition?.father || {};
                        const mother = seniorData.family_composition?.mother || {};
                        const fatherName = `${father.first_name || ''} ${father.middle_name || ''} ${father.last_name || ''} ${father.extension || ''}`.trim();
                        const motherName = `${mother.first_name || ''} ${mother.middle_name || ''} ${mother.last_name || ''}`.trim();
                        
                        document.getElementById('displayFatherName').textContent = fatherName || 'N/A';
                        document.getElementById('displayMotherName').textContent = motherName || 'N/A';
                        
                        // Contact Information
                        const contactsContainer = document.getElementById('displayContacts');
                        contactsContainer.innerHTML = '';
                        
                        if (seniorData.identifying_information?.contacts?.length > 0) {
                            seniorData.identifying_information.contacts.forEach(contact => {
                                const contactElement = document.createElement('div');
                                contactElement.className = 'contact-item';
                                contactElement.innerHTML = `
                                    <p><strong>${contact.type ? contact.type.toUpperCase() : 'CONTACT'}:</strong></p>
                                    <p>Name: ${contact.name || 'N/A'}</p>
                                    <p>Relationship: ${contact.relationship || 'N/A'}</p>
                                    <p>Phone: ${contact.phone || 'N/A'}</p>
                                    ${contact.email ? `<p>Email: ${contact.email}</p>` : ''}
                                    <hr>
                                `;
                                contactsContainer.appendChild(contactElement);
                            });
                        } else {
                            contactsContainer.innerHTML = '<p>No contact information available</p>';
                        }
                        
                        // ID Information
                        const ids = seniorData.identifying_information || {};
                        document.getElementById('displayOscaId').textContent = ids.osca_id_number || 'N/A';
                        document.getElementById('displayGsisSss').textContent = ids.gsis_sss || 'N/A';
                        document.getElementById('displayPhilhealth').textContent = ids.philhealth || 'N/A';
                        document.getElementById('displayTin').textContent = ids.tin || 'N/A';
                        document.getElementById('displayOtherGovtId').textContent = ids.other_govt_id || 'N/A';
                        
                        // Family Composition - Children
                        const childrenContainer = document.getElementById('displayChildren');
                        childrenContainer.innerHTML = '';
                        
                        if (seniorData.family_composition?.children?.length > 0) {
                            seniorData.family_composition.children.forEach(child => {
                                const childElement = document.createElement('div');
                                childElement.className = 'child-item';
                                childElement.innerHTML = `
                                    <p><strong>${child.full_name || 'Unnamed Child'}</strong></p>
                                    <p>Age: ${child.age || 'N/A'}</p>
                                    <p>Occupation: ${child.occupation || 'N/A'}</p>
                                    <p>Income: ${child.income || 'N/A'}</p>
                                    <p>Working Status: ${child.working_status || 'N/A'}</p>
                                    <hr>
                                `;
                                childrenContainer.appendChild(childElement);
                            });
                        } else {
                            childrenContainer.innerHTML = '<p>No children information available</p>';
                        }
                        
                        // Education and Skills
                        const education = seniorData.education_hr_profile || {};
                        document.getElementById('displayEducation').textContent = 
                            Array.isArray(education.educational_attainment) ? 
                            education.educational_attainment.join(', ') : 'N/A';
                        document.getElementById('displaySkills').textContent = 
                            Array.isArray(education.skills) ? 
                            education.skills.join(', ') : 'N/A';
                            
                        // Community Service
                        const serviceContainer = document.getElementById('displayCommunityService');
                        serviceContainer.innerHTML = '';
                        
                        if (seniorData.community_service?.length > 0) {
                            seniorData.community_service.forEach(service => {
                                const serviceElement = document.createElement('p');
                                serviceElement.textContent = service;
                                if (service === 'Other' && seniorData.community_service_other_text) {
                                    serviceElement.textContent += ` (${seniorData.community_service_other_text})`;
                                }
                                serviceContainer.appendChild(serviceElement);
                            });
                        } else {
                            serviceContainer.innerHTML = '<p>No community service recorded</p>';
                        }
                        
                        // Edit Log Information
                        if (seniorData.edit_log && seniorData.edit_log.edited_by) {
                            document.getElementById('displayEditedBy').textContent = seniorData.edit_log.edited_by || 'N/A';
                            if (seniorData.edit_log.edited_at) {
                                const editDate = new Date(seniorData.edit_log.edited_at);
                                document.getElementById('displayEditedAt').textContent = editDate.toLocaleString();
                            } else {
                                document.getElementById('displayEditedAt').textContent = 'N/A';
                            }
                        } else {
                            document.getElementById('displayEditedBy').textContent = 'N/A';
                            document.getElementById('displayEditedAt').textContent = 'N/A';
                        }
                        
                        // Show the view modal
                        $('#viewModal').modal('show');
                        
                    } catch (e) {
                        console.error('Error parsing senior data:', e);
                    }
                }
                
                // Handle edit button clicks
                if (e.target.closest('.edit-btn')) {
                    console.log('Edit button clicked!'); // Debug log
                    const button = e.target.closest('.edit-btn');
                    try {
                        const seniorData = JSON.parse(button.getAttribute('data-senior'));
                        console.log('Edit Senior Data:', seniorData);
                        
                        // Store the resident ID
                        document.getElementById('editResidentId').value = seniorData._id;
                        
                        // Populate Personal Information
                        const name = seniorData.identifying_information?.name || {};
                        document.getElementById('editFirstName').value = name.first_name || '';
                        document.getElementById('editMiddleName').value = name.middle_name || '';
                        document.getElementById('editLastName').value = name.last_name || '';
                        
                        // Populate Address Information
                        const address = seniorData.identifying_information?.address || {};
                        document.getElementById('editBarangay').value = address.barangay || '';
                        
                        // Trigger barangay change to populate purok options
                        const barangaySelect = document.getElementById('editBarangay');
                        if (address.barangay) {
                            updateEditPurokOptions(address.barangay, address.purok);
                        }
                        
                        // Populate other personal information
                        document.getElementById('editGender').value = seniorData.identifying_information?.gender || '';
                        
                        // Handle date formatting for birthday
                        const dob = seniorData.identifying_information?.date_of_birth;
                        if (dob) {
                            const date = new Date(dob);
                            const formattedDate = date.toISOString().split('T')[0];
                            document.getElementById('editBirthday').value = formattedDate;
                        }
                        
                        document.getElementById('editAge').value = seniorData.identifying_information?.age || '';
                        document.getElementById('editMaritalStatus').value = seniorData.identifying_information?.marital_status || '';
                        
                        // Handle place of birth (could be array or string)
                        const placeOfBirth = seniorData.identifying_information?.place_of_birth;
                        document.getElementById('editPlaceOfBirth').value = 
                            Array.isArray(placeOfBirth) ? placeOfBirth.join(', ') : (placeOfBirth || '');
                        
                        // Handle spouse information
                        const spouseGroup = document.getElementById('editSpouseGroup');
                        const maritalStatus = seniorData.identifying_information?.marital_status;
                        if (maritalStatus === 'Married') {
                            spouseGroup.style.display = 'block';
                            document.getElementById('editSpouseName').value = seniorData.family_composition?.spouse?.name || '';
                        } else {
                            spouseGroup.style.display = 'none';
                        }
                        
                        // Populate ID Information
                        const ids = seniorData.identifying_information || {};
                        document.getElementById('editOscaId').value = ids.osca_id_number || '';
                        document.getElementById('editGsisSss').value = ids.gsis_sss || '';
                        document.getElementById('editPhilhealth').value = ids.philhealth || '';
                        document.getElementById('editTin').value = ids.tin || '';
                        
                        // Populate Family Information
                        const father = seniorData.family_composition?.father || {};
                        const mother = seniorData.family_composition?.mother || {};
                        const fatherName = `${father.first_name || ''} ${father.middle_name || ''} ${father.last_name || ''} ${father.extension || ''}`.trim();
                        const motherName = `${mother.first_name || ''} ${mother.middle_name || ''} ${mother.last_name || ''}`.trim();
                        
                        document.getElementById('editFatherName').value = fatherName;
                        document.getElementById('editMotherName').value = motherName;
                        
                        // Populate Contact Information
                        populateEditContacts(seniorData.identifying_information?.contacts || []);
                        
                        // Show the edit modal
                        console.log('About to show edit modal'); // Debug log
                        
                        // Try jQuery first, then fallback to vanilla JS
                        if (typeof $ !== 'undefined' && $.fn.modal) {
                            $('#editModal').modal('show');
                            console.log('Edit modal show called via jQuery'); // Debug log
                        } else {
                            // Fallback to vanilla JS
                            const modal = document.getElementById('editModal');
                            if (modal) {
                                modal.style.display = 'block';
                                modal.classList.add('show');
                                modal.setAttribute('aria-hidden', 'false');
                                document.body.classList.add('modal-open');
                                
                                // Add backdrop
                                const backdrop = document.createElement('div');
                                backdrop.className = 'modal-backdrop fade show';
                                backdrop.id = 'editModalBackdrop';
                                document.body.appendChild(backdrop);
                                
                                console.log('Edit modal show called via vanilla JS'); // Debug log
                            } else {
                                console.error('Edit modal element not found!');
                            }
                        }
                        
                    } catch (e) {
                        console.error('Error parsing senior data for edit:', e);
                        alert('Error loading data for editing. Please try again.');
                    }
                }
            });

            // Function to update purok options in edit modal
            function updateEditPurokOptions(selectedBarangay, selectedPurok = '') {
                const purokSelect = document.getElementById('editPurok');
                purokSelect.innerHTML = '<option value="">Select Purok</option>';
                
                if (selectedBarangay && barangaysData[selectedBarangay]) {
                    barangaysData[selectedBarangay].forEach(purok => {
                        const option = document.createElement('option');
                        option.value = purok;
                        option.textContent = purok;
                        if (purok === selectedPurok) {
                            option.selected = true;
                        }
                        purokSelect.appendChild(option);
                    });
                }
            }

            // Function to populate edit contacts
            function populateEditContacts(contacts) {
                const container = document.getElementById('editContactsContainer');
                container.innerHTML = '';
                
                if (contacts.length === 0) {
                    // Add one empty contact form if no contacts exist
                    addEditContactForm(0, {});
                } else {
                    contacts.forEach((contact, index) => {
                        addEditContactForm(index, contact);
                    });
                }
            }

            // Function to add contact form in edit modal
            function addEditContactForm(index, contact = {}) {
                const container = document.getElementById('editContactsContainer');
                const contactDiv = document.createElement('div');
                contactDiv.className = 'contact-form-group mb-3 p-3 border rounded';
                contactDiv.innerHTML = `
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Contact Type</label>
                                <select class="form-control" name="contacts[${index}][type]">
                                    <option value="primary" ${contact.type === 'primary' ? 'selected' : ''}>Primary</option>
                                    <option value="secondary" ${contact.type === 'secondary' ? 'selected' : ''}>Secondary</option>
                                    <option value="emergency" ${contact.type === 'emergency' ? 'selected' : ''}>Emergency</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Full Name</label>
                                <input type="text" class="form-control" name="contacts[${index}][name]" value="${contact.name || ''}">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Relationship</label>
                                <input type="text" class="form-control" name="contacts[${index}][relationship]" value="${contact.relationship || ''}">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Phone Number</label>
                                <input type="tel" class="form-control" name="contacts[${index}][phone]" value="${contact.phone || ''}">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Email</label>
                                <input type="email" class="form-control" name="contacts[${index}][email]" value="${contact.email || ''}">
                            </div>
                        </div>
                    </div>
                    <button type="button" class="btn btn-sm btn-danger remove-contact">Remove Contact</button>
                `;
                container.appendChild(contactDiv);
                
                // Add remove contact handler
                contactDiv.querySelector('.remove-contact').addEventListener('click', function() {
                    contactDiv.remove();
                });
            }

            // Add contact button handler for edit modal
            document.getElementById('addEditContact').addEventListener('click', function() {
                const container = document.getElementById('editContactsContainer');
                const index = container.children.length;
                addEditContactForm(index);
            });

            // Edit barangay change handler
            document.getElementById('editBarangay').addEventListener('change', function() {
                const selectedBarangay = this.value;
                updateEditPurokOptions(selectedBarangay);
            });

            // Edit marital status change handler
            document.getElementById('editMaritalStatus').addEventListener('change', function() {
                const spouseGroup = document.getElementById('editSpouseGroup');
                if (this.value === 'Married') {
                    spouseGroup.style.display = 'block';
                } else {
                    spouseGroup.style.display = 'none';
                }
            });

            // Edit birthday change handler for age calculation
            document.getElementById('editBirthday').addEventListener('change', function() {
                const birthday = new Date(this.value);
                const today = new Date();
                let age = today.getFullYear() - birthday.getFullYear();
                const monthDiff = today.getMonth() - birthday.getMonth();
                
                if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthday.getDate())) {
                    age--;
                }
                
                document.getElementById('editAge').value = age;
            });

            // Close modal handlers for vanilla JS fallback
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('modal') || e.target.classList.contains('close') || e.target.getAttribute('data-dismiss') === 'modal') {
                    const modal = document.getElementById('editModal');
                    if (modal && modal.classList.contains('show')) {
                        modal.style.display = 'none';
                        modal.classList.remove('show');
                        modal.setAttribute('aria-hidden', 'true');
                        document.body.classList.remove('modal-open');
                        
                        // Remove backdrop
                        const backdrop = document.getElementById('editModalBackdrop');
                        if (backdrop) {
                            backdrop.remove();
                        }
                    }
                }
            });

            // Update button handler
            document.getElementById('updateBtn').addEventListener('click', function() {
                const form = document.getElementById('editResidentForm');
                const formData = new FormData(form);
                
                // Convert FormData to JSON
                const jsonData = {
                    // Add edit tracking information (will be overridden by backend session for security)
                    edited_by: '<%= (user && user.email) ? user.email : "Unknown" %>',
                    edited_at: new Date().toISOString()
                };
                for (let [key, value] of formData.entries()) {
                    if (key.includes('contacts[')) {
                        // Handle contacts array
                        if (!jsonData.contacts) jsonData.contacts = {};
                        
                        const match = key.match(/contacts\[(\d+)\]\[(\w+)\]/);
                        if (match) {
                            const index = match[1];
                            const field = match[2];
                            if (!jsonData.contacts[index]) jsonData.contacts[index] = {};
                            jsonData.contacts[index][field] = value;
                        }
                    } else {
                        jsonData[key] = value;
                    }
                }
                
                // Convert contacts object to array
                if (jsonData.contacts) {
                    jsonData.contacts = Object.values(jsonData.contacts);
                }
                
                console.log('Update data:', jsonData);
                
                // Send update request
                fetch('/update-senior', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(jsonData)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Senior citizen information updated successfully!');
                        $('#editModal').modal('hide');
                        // Reload the page to show updated data
                        window.location.reload();
                    } else {
                        alert('Error updating information: ' + (data.error || 'Unknown error'));
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error updating information. Please try again.');
                });
            });

            // Initialize DataTable
            var table = $('#example').DataTable({
                paging: true,
                pageLength: 10,
                lengthMenu: [5, 10, 25, 50, 100],
                responsive: true,
                columnDefs: [
                    {
                        targets: 0, // First column (checkbox column)
                        searchable: false,
                        orderable: false
                    }
                ],
                order: [[1, 'asc']], // Sort by second column (Full Name) by default
                rowCallback: function(row) {
                    if ($(row).hasClass('dt-empty')) {
                        $(row).hide();
                    }
                }
            });

            // Select All functionality
            $('#select-all').on('click', function() {
                const isChecked = $(this).prop('checked');
                // Select/deselect all visible rows on current page
                table.rows({ page: 'current' }).nodes().to$().find('.row-checkbox').prop('checked', isChecked);
                // Update the SMS button state
                const openSmsBtn = document.getElementById('openSmsForSelected');
                if (openSmsBtn) {
                    const anyChecked = Array.from(document.querySelectorAll('.row-checkbox')).some(cb => cb.checked);
                    openSmsBtn.disabled = !anyChecked;
                }
            });

            // Update select-all checkbox state when individual checkboxes change
            $(document).on('change', '.row-checkbox', function() {
                const totalVisible = table.rows({ page: 'current' }).nodes().to$().find('.row-checkbox').length;
                const checkedVisible = table.rows({ page: 'current' }).nodes().to$().find('.row-checkbox:checked').length;
                $('#select-all').prop('checked', totalVisible > 0 && totalVisible === checkedVisible);
                // Update the SMS button state
                const openSmsBtn = document.getElementById('openSmsForSelected');
                if (openSmsBtn) {
                    const anyChecked = Array.from(document.querySelectorAll('.row-checkbox')).some(cb => cb.checked);
                    openSmsBtn.disabled = !anyChecked;
                }
            });

            // Update select-all state when table is redrawn (pagination, filtering, etc.)
            table.on('draw', function() {
                const totalVisible = table.rows({ page: 'current' }).nodes().to$().find('.row-checkbox').length;
                const checkedVisible = table.rows({ page: 'current' }).nodes().to$().find('.row-checkbox:checked').length;
                $('#select-all').prop('checked', totalVisible > 0 && totalVisible === checkedVisible);
            });

            // Search input functionality
            $('#seniorSearchInput').on('keyup', function() {
                table.search(this.value).draw();
            });

            // Clear search button
            $('#clearSearchBtn').on('click', function() {
                $('#seniorSearchInput').val('');
                table.search('').draw();
            });

            // Combine with existing filters
            $('#barangay-filter, #purok-filter').on('change', function() {
                table.draw();
            });

            // Custom filtering function
            $.fn.dataTable.ext.search.push(
                function(settings, data, dataIndex) {
                    var barangay = $('#barangay-filter').val();
                    var purok = $('#purok-filter').val();
                    
                    // If no barangay is selected, show all
                    if (!barangay) return true;
                    
                    var rowBarangay = data[3]; // Barangay is in the 4th column (index 3) after checkbox
                    var rowPurok = data[4]; // Purok is in the 5th column (index 4) after checkbox
                    
                    // Filter by barangay
                    if (barangay && rowBarangay !== barangay) return false;
                    
                    // Filter by purok if selected and not "all"
                    if (purok && purok !== 'all' && rowPurok !== purok) return false;
                    
                    return true;
                }
            );

            // ARCHIVE FUNCTIONALITY FOR SENIOR CITIZENS
            const archiveButtons = document.querySelectorAll('.archive-btn');
            archiveButtons.forEach(button => {
                button.addEventListener('click', async function() {
                    const seniorId = this.getAttribute('data-senior-id');
                    const currentStatus = this.getAttribute('data-status');
                    const isArchived = currentStatus === 'Archived';
                    
                    if (!seniorId) {
                        alert('Error: Senior Citizen ID not found');
                        return;
                    }

                    // Confirm action
                    const action = isArchived ? 'unarchive' : 'archive';
                    const confirmMessage = isArchived 
                        ? 'Are you sure you want to unarchive this Senior Citizen record?'
                        : 'Are you sure you want to archive this Senior Citizen record?';
                    
                    if (!confirm(confirmMessage)) {
                        return;
                    }

                    // Disable button during request
                    const originalHTML = this.innerHTML;
                    this.disabled = true;
                    this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';

                    try {
                        const endpoint = isArchived ? '/unarchive-senior' : '/archive-senior';
                        const response = await fetch(endpoint, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ senior_id: seniorId })
                        });

                        const data = await response.json();

                        if (data.success) {
                            alert(data.message || `Senior Citizen record ${action}d successfully`);
                            // Reload the page to reflect the changes
                            window.location.reload();
                        } else {
                            alert('Error: ' + (data.message || 'Failed to ' + action + ' record'));
                            this.disabled = false;
                            this.innerHTML = originalHTML;
                        }
                    } catch (error) {
                        console.error('Archive error:', error);
                        alert('An error occurred while ' + action + 'ing the record. Please try again.');
                        this.disabled = false;
                        this.innerHTML = originalHTML;
                    }
                });
            });
        });
    </script>

    <script>
    // Character Counter (SMS)
    (function() {
        const smsMessage = document.getElementById('smsMessage');
        const charCount = document.getElementById('charCount');

        function updateCharCount() {
            if (!charCount || !smsMessage) return;
            charCount.textContent = smsMessage.value.length;
        }

        if (smsMessage) {
            smsMessage.addEventListener('input', updateCharCount);
            updateCharCount(); // Initial count
        }

        // Attach SMS handler and modal logic
        (function() {
            const sendBtn = document.getElementById('sendSmsBtn');
            const recipientsListEl = document.getElementById('recipientsList');
            const openSmsBtn = document.getElementById('openSmsForSelected');

            if (sendBtn) {
                sendBtn.addEventListener('click', async function() {
                    const btn = this;
                    
                    // Prevent multiple simultaneous sends
                    if (btn.dataset.sending === '1') return;
                    btn.dataset.sending = '1';

                    const originalText = btn.innerHTML;
                    const messageEl = document.getElementById('smsMessage');
                    const message = messageEl ? messageEl.value.trim() : '';
                    const recipients = recipientsListEl ? Array.from(recipientsListEl.querySelectorAll('.recipient-item')).map(el => ({
                        phone: el.dataset.phone,
                        name: el.dataset.name,
                        first_name: el.dataset.firstName || '',
                        middle_name: el.dataset.middleName || '',
                        last_name: el.dataset.lastName || '',
                        barangay: el.dataset.barangay || '',
                        purok: el.dataset.purok || '',
                        record_id: el.dataset.recordId || '',
                        recipient_type: 'Senior'
                    })) : [];

                    // Validation
                    if (!message) {
                        delete btn.dataset.sending;
                        alert('Please enter a message');
                        return;
                    }
                    if (!recipients.length) {
                        delete btn.dataset.sending;
                        alert('No recipients selected');
                        return;
                    }

                    // UI feedback
                    btn.setAttribute('disabled', 'disabled');
                    btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Sending...';

                    try {
                        const resp = await fetch('/send-sms', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ recipients, message })
                        });

                        // Check HTTP status first
                        if (!resp.ok) {
                            throw new Error(`HTTP error! status: ${resp.status}`);
                        }

                        // Try to parse JSON response
                        let data = null;
                        try {
                            data = await resp.json();
                        } catch (jsonErr) {
                            console.warn('Invalid JSON response from server:', jsonErr);
                            // Even if JSON parsing fails, if we got 200, consider it success
                            alert('SMS has been sent successfully!');
                            closeModalAndReset();
                            return;
                        }

                        // Check for success in response data
                        if (data && data.success === true) {
                            alert('SMS has been sent successfully!');
                            console.log('SMS results:', data.results);
                            closeModalAndReset();
                        } else {
                            // Server returned success: false or no success property
                            const errorMsg = data && data.error ? data.error : 'SMS sending failed';
                            console.error('SMS service reported failure:', errorMsg);
                            alert('Failed to send SMS: ' + errorMsg);
                        }

                    } catch (err) {
                        console.error('Error sending SMS:', err);
                        // Only show service down message for network errors or server errors
                        if (err.message.includes('HTTP error') || err.name === 'TypeError') {
                            alert('The SMS service is down at the moment, sorry. Please try again later.');
                        } else {
                            alert('An unexpected error occurred: ' + err.message);
                        }
                    } finally {
                        // Always clean up
                        delete btn.dataset.sending;
                        btn.removeAttribute('disabled');
                        btn.innerHTML = originalText;
                    }
                });
            }

            function closeModalAndReset() {
                // Close modal
                const modalEl = document.getElementById('assistanceModal');
                if (modalEl && typeof bootstrap !== 'undefined' && bootstrap.Modal) {
                    const modal = bootstrap.Modal.getInstance(modalEl);
                    if (modal) modal.hide();
                } else if (typeof $ !== 'undefined' && $.fn.modal) {
                    $('#assistanceModal').modal('hide');
                } else {
                    modalEl.style.display = 'none';
                    modalEl.classList.remove('show');
                }

                // Reset form
                const form = document.getElementById('smsForm');
                if (form) form.reset();
                updateCharCount();
            }

            // Open SMS modal for selected rows
            if (openSmsBtn && recipientsListEl) {
                function refreshOpenSmsState() {
                    const anyChecked = Array.from(document.querySelectorAll('.row-checkbox')).some(cb => cb.checked);
                    openSmsBtn.disabled = !anyChecked;
                }

                openSmsBtn.addEventListener('click', function() {
                    const selected = Array.from(document.querySelectorAll('.row-checkbox:checked'));
                    recipientsListEl.innerHTML = '';

                    if (!selected.length) {
                        recipientsListEl.innerHTML = '<em>No recipients selected</em>';
                        return;
                    }

                    selected.forEach(cb => {
                        const phone = cb.dataset.phone || cb.getAttribute('data-phone') || '';
                        const name = cb.dataset.name || cb.getAttribute('data-name') || '';

                        // Only add if phone number exists
                        if (phone) {
                            const item = document.createElement('div');
                            item.className = 'recipient-item';
                            item.dataset.phone = phone;
                            item.dataset.name = name;
                            item.dataset.firstName = cb.dataset.firstName || cb.getAttribute('data-first-name') || '';
                            item.dataset.middleName = cb.dataset.middleName || cb.getAttribute('data-middle-name') || '';
                            item.dataset.lastName = cb.dataset.lastName || cb.getAttribute('data-last-name') || '';
                            item.dataset.barangay = cb.dataset.barangay || cb.getAttribute('data-barangay') || '';
                            item.dataset.purok = cb.dataset.purok || cb.getAttribute('data-purok') || '';
                            item.dataset.recordId = cb.dataset.recordId || cb.getAttribute('data-record-id') || cb.value;
                            item.style.padding = '4px 6px';
                            item.style.borderBottom = '1px solid #f1f1f1';
                            item.innerHTML = `<strong>${name}</strong> <span class="text-muted">${phone}</span>`;
                            recipientsListEl.appendChild(item);
                        }
                    });

                    // Show modal
                    const modalEl = document.getElementById('assistanceModal');
                    if (modalEl && typeof bootstrap !== 'undefined' && bootstrap.Modal) {
                        const modal = new bootstrap.Modal(modalEl);
                        modal.show();
                    } else if (typeof $ !== 'undefined' && $.fn.modal) {
                        $('#assistanceModal').modal('show');
                    } else {
                        modalEl.style.display = 'block';
                        modalEl.classList.add('show');
                    document.body.classList.add('modal-open');
                    const backdrop = document.createElement('div');
                    backdrop.className = 'modal-backdrop fade show';
                    document.body.appendChild(backdrop);
                    }
                });

                // Watch row checkboxes to enable/disable openSmsBtn
                document.querySelectorAll('.row-checkbox').forEach(cb => cb.addEventListener('change', refreshOpenSmsState));
                refreshOpenSmsState();
            }
        })();

        // Reset form when modal is closed
        const assistanceModalEl = document.getElementById('assistanceModal');
        if (assistanceModalEl) {
            assistanceModalEl.addEventListener('hidden.bs.modal', function () {
                const form = document.getElementById('smsForm');
                if (form) form.reset();
                updateCharCount();
            });
        }
    })();

    // SMS HISTORY FUNCTIONALITY FOR SENIOR CITIZENS
    document.addEventListener('DOMContentLoaded', function() {
        const viewSmsHistoryBtn = document.getElementById('viewSmsHistoryBtn');
        if (viewSmsHistoryBtn) {
            viewSmsHistoryBtn.addEventListener('click', async function() {
                const modalEl = document.getElementById('smsHistoryModal');
                const tableBody = document.getElementById('smsHistoryTableBody');
                
                // Show modal
                if (typeof $ !== 'undefined' && $.fn.modal) {
                    $('#smsHistoryModal').modal('show');
                } else if (modalEl && typeof bootstrap !== 'undefined' && bootstrap.Modal) {
                    const modal = new bootstrap.Modal(modalEl);
                    modal.show();
                }
                
                // Show loading
                tableBody.innerHTML = '<tr><td colspan="7" class="text-center">Loading...</td></tr>';
                
                try {
                    const response = await fetch('/sms-history?recipient_type=Senior&limit=200');
                    const data = await response.json();
                    
                    if (data.success && data.data) {
                        if (data.data.length === 0) {
                            tableBody.innerHTML = '<tr><td colspan="7" class="text-center">No SMS history found</td></tr>';
                        } else {
                            tableBody.innerHTML = '';
                            data.data.forEach(record => {
                                const row = document.createElement('tr');
                                const sentDate = new Date(record.sent_at);
                                const fullName = `${record.first_name || ''} ${record.middle_name || ''} ${record.last_name || ''}`.trim();
                                const statusBadge = record.status === 'sent' 
                                    ? '<span class="badge badge-success">Sent</span>'
                                    : record.status === 'error'
                                    ? '<span class="badge badge-danger">Error</span>'
                                    : '<span class="badge badge-warning">Skipped</span>';
                                
                                row.innerHTML = `
                                    <td>${sentDate.toLocaleString()}</td>
                                    <td>${record.phone_number || 'N/A'}</td>
                                    <td>${fullName || 'N/A'}</td>
                                    <td>${record.barangay || 'N/A'}</td>
                                    <td>${record.purok || 'N/A'}</td>
                                    <td style="max-width: 200px; word-wrap: break-word;">${record.message || 'N/A'}</td>
                                    <td>${statusBadge}</td>
                                `;
                                tableBody.appendChild(row);
                            });
                        }
                    } else {
                        tableBody.innerHTML = '<tr><td colspan="7" class="text-center text-danger">Error loading SMS history</td></tr>';
                    }
                } catch (error) {
                    console.error('Error loading SMS history:', error);
                    tableBody.innerHTML = '<tr><td colspan="7" class="text-center text-danger">Error loading SMS history</td></tr>';
                }
            });
        }
    });
</script>

    <!-- Required Jquery -->
    <script type="text/javascript" src="\bower_components\jquery\js\jquery.min.js"></script>
    <script type="text/javascript" src="\bower_components\jquery-ui\js\jquery-ui.min.js"></script>
    <script type="text/javascript" src="\bower_components\popper.js\js\popper.min.js"></script>
    <script type="text/javascript" src="\bower_components\bootstrap\js\bootstrap.min.js"></script>
    <!-- DataTables JS -->
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <!-- Other scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.1/chart.min.js"></script>
    <script type="text/javascript" src="\bower_components\jquery-slimscroll\js\jquery.slimscroll.js"></script>
    <script type="text/javascript" src="\bower_components\modernizr\js\modernizr.js"></script>
    <script type="text/javascript" src="\bower_components\modernizr\js\css-scrollbars.js"></script>
    <script type="text/javascript" src="\bower_components\chart.js\js\Chart.js"></script>
    <script src="\assets\pages\widget\amchart\amcharts.js"></script>
    <script src="\assets\pages\widget\amchart\serial.js"></script>
    <script src="\assets\pages\widget\amchart\light.js"></script>
    <script type="text/javascript" src="\assets\js\SmoothScroll.js"></script>
    <script src="\assets\js\pcoded.min.js"></script>
    <script src="\assets\js\jquery.mCustomScrollbar.concat.min.js"></script>
    <script src="\assets\js\vartical-layout.min.js"></script>
    <script type="text/javascript" src="\assets\pages\dashboard\analytic-dashboard.min.js"></script>
    <script type="text/javascript" src="\assets\js\script.js"></script>
    <script type="text/javascript" src="\assets\js\senior.js"></script>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-23581568-13"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() {
            dataLayer.push(arguments);
        }
        gtag('js', new Date());
        gtag('config', 'UA-23581568-13');
    </script>
</body>
</html>