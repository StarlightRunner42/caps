<!DOCTYPE html>
<html lang="en">
	<head>
		<title>PWD-Person With Disability</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimal-ui">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<!-- Favicon -->
		<link rel="icon" href="/assets/images/silay.png" type="image/x-icon">
		<!-- Google Fonts -->
		<link href="https://fonts.googleapis.com/css?family=Open+Sans:400,600,800" rel="stylesheet">
		<!-- CSS Frameworks -->
		<link rel="stylesheet" href="/bower_components/bootstrap/css/bootstrap.min.css">
		<link rel="stylesheet" href="/assets/icon/feather/css/feather.css">
		<link rel="stylesheet" href="/assets/css/style.css">
		<link rel="stylesheet" href="/assets/css/pwd.css">
		<link rel="stylesheet" href="/assets/css/jquery.mCustomScrollbar.css">
		<!-- DataTables CSS -->
		<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
	</head>
	<body>
		<!-- Pre-loader start -->
		<div class="theme-loader">
			<div class="ball-scale">
				<div class='contain'>
					<div class="ring">
						<div class="frame"></div>
					</div>
					<div class="ring">
						<div class="frame"></div>
					</div>
					<div class="ring">
						<div class="frame"></div>
					</div>
					<div class="ring">
						<div class="frame"></div>
					</div>
					<div class="ring">
						<div class="frame"></div>
					</div>
					<div class="ring">
						<div class="frame"></div>
					</div>
					<div class="ring">
						<div class="frame"></div>
					</div>
					<div class="ring">
						<div class="frame"></div>
					</div>
					<div class="ring">
						<div class="frame"></div>
					</div>
					<div class="ring">
						<div class="frame"></div>
					</div>
				</div>
			</div>
		</div>
		<!-- Pre-loader end -->
		<div id="pcoded" class="pcoded">
			<div class="pcoded-overlay-box"></div>
			<div class="pcoded-container navbar-wrapper">
				<nav class="navbar header-navbar pcoded-header">
					<div class="navbar-wrapper">
						<div class="navbar-logo">
							<a class="mobile-menu" id="mobile-collapse" href="#!">
								<i class="feather icon-menu"></i>
							</a>
							<a href="index-1.htm">
    <span class="logo-text">SILAY CITY</span>
</a>
							<a class="mobile-options">
								<i class="feather icon-more-horizontal"></i>
							</a>
						</div>
						<div class="navbar-container container-fluid">
							<ul class="nav-left">
								<li class="header-search">
									<div class="main-search morphsearch-search">
										<div class="input-group">
											<span class="input-group-addon search-close">
												<i class="feather icon-x"></i>
											</span>
											<input type="text" class="form-control" placeholder="Search...">
											<span class="input-group-addon search-btn">
												<i class="feather icon-search"></i>
											</span>
										</div>
									</div>
								</li>
								<li>
									<a href="#!" onclick="javascript:toggleFullScreen()">
										<i class="feather icon-maximize full-screen"></i>
									</a>
								</li>
								<li>
									<a href="/add_pwd" class="btn btn-primary rounded" target="_blank">
										<i class="feather icon-user-plus"></i>ADD PDAO </a>
								</li>

								<li style="list-style: none;">
        <!-- <a href="#" class="btn btn-primary rounded" id="addSeniorBtn" data-bs-toggle="modal" data-bs-target="#assistanceModal">
            <i data-feather="user-plus"></i> ADD ASSISTANCE
        </a> -->
    </li>
							</ul>
							<ul class="nav-right"></ul>
							<ul class="nav-right">
								<li class="user-profile header-notification">
									<div class="dropdown-primary dropdown">
										<div class="dropdown-toggle" data-toggle="dropdown">
											<i class="feather icon-chevron-down"></i>
										</div>
										<ul class="show-notification profile-notification dropdown-menu" data-dropdown-in="fadeIn" data-dropdown-out="fadeOut">
											<li>
												<a href="/logout">
													<i class="feather icon-log-out"></i> Logout </a>
											</li>
										</ul>
									</div>
								</li>
							</ul>
						</div>
					</div>
				</nav>
				<div class="pcoded-main-container">
					<div class="pcoded-wrapper">
						<nav class="pcoded-navbar">
							<div class="pcoded-inner-navbar main-menu">
								<div class="pcoded-navigatio-lavel">Navigation</div>
								<ul class="pcoded-item pcoded-left-item">
									<li class="pcoded-hasmenu active pcoded-trigger">
										<a href="javascript:void(0)">
											<span class="pcoded-micon">
												<i class="feather icon-home"></i>
											</span>
											<span class="pcoded-mtext">Dashboard</span>
										</a>
										<ul class="pcoded-submenu">
											<li class="active">
												<a href="/Pwd-form">
													<span class="">PDAO</span>
												</a>
											</li>
											<li class="">
												<a href="/Senior-form">
													<span class="">OSCA</span>
												</a>
											</li>
										</ul>
									</li>
								</ul>
							</div>
						</nav>
						<div class="pcoded-content">
							<div class="pcoded-inner-content">
								<div class="main-body">
									<div class="page-wrapper">
										
										<div class="container">
											<h1>PWD-PERSON WITH DISABILITY</h1>
											<div class="filter-container">
												<div class="filter-group">
													<label for="barangay-filter">Barangay:</label>
													<select id="barangay-filter" class="form-control">
														<option value="">All Barangays</option><% Object.keys(barangays).forEach(barangay => { %> <option value="<%= barangay %>"><%= barangay %> </option><% }) %>
													</select>
												</div>
												<div class="filter-group">
													<label for="purok-filter">Purok:</label>
													<select id="purok-filter" class="form-control" disabled>
														<option value="">First select a Barangay</option>
													</select>
												</div>

												<!-- Status Filter -->
												<div class="filter-group" style="margin-left: 12px;">
													<label for="status-filter">Status:</label>
													<select id="status-filter" class="form-control">
														<option value="active">Active Only</option>
														<option value="archived">Archived Only</option>
														<option value="all">All Records</option>
													</select>
												</div>
												
												<!-- Generate Report Button - MOVED INSIDE THE CONTAINER -->
												<div class="filter-group" style="margin-right: 5px;">
													<label>&nbsp;</label>
													<!-- <button id="generateReportBtn" class="btn btn-info" type="button">
														 Generate Report
													</button> -->
												</div>
												
											</div>
											<% if (pwds && pwds.length > 0) { %>
											<!-- Report Modal -->
											<div class="modal fade" id="reportModal" tabindex="-1" aria-labelledby="reportModalLabel" aria-hidden="true">
												<div class="modal-dialog modal-dialog-centered modal-lg">
													<div class="modal-content">
														<div class="modal-header">
															<h5 class="modal-title" id="reportModalLabel">PWD Disability Report</h5>
															<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
														</div>
														<div class="modal-body">
															<div id="reportContent" style="white-space:pre-wrap; font-family: monospace;"></div>
														</div>
														<div class="modal-footer">
															<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
															<button id="copyReportBtn" type="button" class="btn btn-outline-primary">Copy</button>
															<a id="downloadReportLink" class="btn btn-primary" download="pwd_report.txt">Download</a>
														</div>
													</div>
												</div>
											</div>
											 <table id="example" class="display" style="width:100%">
	<thead>
		<tr>
			<th>
				<input type="checkbox" id="select-all" aria-label="Select all rows">
			</th>
			<th>Full Name</th>
			<th>Age</th>
			<th>Barangay</th>
			<th>Purok</th>
			<th>Civil Status</th>
			<th>Status</th>
			<th>Actions</th>
		</tr>
	</thead>
	<tbody>
			<% pwds.forEach(pwd => { %>
		<tr>
			<td>
				<input type="checkbox" class="row-checkbox" value="<%= pwd._id || pwd.id %>" aria-label="Select row"
					data-phone="<%= (pwd.contacts && pwd.contacts.length && pwd.contacts[0].phone) ? pwd.contacts[0].phone : '' %>"
					data-name="<%= (pwd.first_name || '') + ' ' + (pwd.last_name || '') %>"
					data-first-name="<%= pwd.first_name || '' %>"
					data-middle-name="<%= pwd.middle_name || '' %>"
					data-last-name="<%= pwd.last_name || '' %>"
					data-barangay="<%= pwd.barangay || '' %>"
					data-purok="<%= pwd.purok || '' %>"
					data-record-id="<%= pwd._id || pwd.id %>">
			</td>
			<td><%= pwd.first_name %> <%= pwd.middle_name %> <%= pwd.last_name %></td>
			<td><%= pwd.age %></td>
			<td><%= pwd.barangay %></td>
			<td><%= pwd.purok %></td>
			<td><%= pwd.civil_status %></td>
			<td>
				<span class="badge <%= (pwd.status === 'Archived') ? 'badge-secondary' : 'badge-success' %>">
					<%= pwd.status || 'Active' %>
				</span>
			</td>
			<td>
				<div class="action-container">
					<button class="action action-primary view-btn" aria-label="View" data-toggle="modal" data-target="#viewModal" 
						data-pwd-id="<%= pwd._id || pwd.id %>"
						data-pwd='<%= JSON.stringify(pwd).replace(/'/g, "&apos;") %>'>
						<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
						</svg>
					</button>
					<button class="action action-edit edit-btn" aria-label="Edit" data-toggle="modal" data-target="#editModal"
						data-pwd='<%= JSON.stringify(pwd).replace(/'/g, "&apos;") %>'>
						<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
						</svg>
					</button>
					<button class="action action-archive archive-btn" aria-label="Archive" 
						data-pwd-id="<%= pwd._id || pwd.id %>"
						data-status="<%= pwd.status || 'Active' %>"
						title="<%= (pwd.status === 'Archived') ? 'Unarchive' : 'Archive' %>">
						<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" />
						</svg>
					</button>

					
					<!-- Modal -->
    <div class="modal fade" id="assistanceModal" tabindex="-1" aria-labelledby="assistanceModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="assistanceModalLabel">
                        <i data-feather="send" style="width: 20px; height: 20px;"></i> Send SMS Assistance
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
								<form id="smsForm">

									<div class="mb-2">
										<label class="form-label">Recipients</label>
										<div id="recipientsList" style="max-height:150px; overflow:auto; border:1px solid #e9ecef; padding:8px; border-radius:4px;">
											<!-- Filled dynamically with selected recipients -->
											<em>No recipients selected</em>
										</div>
									</div>

									<div class="sms-template">
										<label class="form-label">
											<i data-feather="message-square" style="width: 16px; height: 16px;"></i> Message Template
										</label>
										<textarea class="form-control" id="smsMessage" rows="6" required>Hello!You are eligible for PWD benefits Visit your local office to claim.Thank you!</textarea>
										<small class="text-muted">You can edit this message before sending</small>
									</div>

                        <!-- Character Counter -->
                        <div class="mb-3">
                            <small class="text-muted">
                                Characters: <span id="charCount">0</span>/160
                            </small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i data-feather="x" style="width: 16px; height: 16px;"></i> Cancel
                    </button>
					<button type="button" class="btn btn-primary btn-send" id="sendSmsBtn">
                        <i data-feather="send" style="width: 16px; height: 16px;"></i> Send SMS
                    </button>
                </div>
            </div>
        </div>
    </div>
															
															<!-- SMS History Modal -->
															
<div class="modal fade" id="smsHistoryModal" tabindex="-1" aria-labelledby="smsHistoryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="smsHistoryModalLabel">
                    <i data-feather="clock"></i> SMS History
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
															<div class="modal-body">
																<!-- Filter Controls -->
																<div class="row mb-3">
																	<div class="col-md-6">
																		<label for="smsHistoryBarangayFilter">Filter by Barangay:</label>
																		<select id="smsHistoryBarangayFilter" class="form-control">
																			<option value="">All Barangays</option>
																			<% Object.keys(barangays).forEach(barangay => { %>
																				<option value="<%= barangay %>"><%= barangay %></option>
																			<% }) %>
																		</select>
																	</div>
																	<div class="col-md-6">
																		<label for="smsHistoryPurokFilter">Filter by Purok:</label>
																		<select id="smsHistoryPurokFilter" class="form-control" disabled>
																			<option value="">First select a Barangay</option>
																		</select>
																	</div>
																</div>
																<div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
																	<table class="table table-striped table-bordered table-hover">
																		<thead class="table-dark" style="position: sticky; top: 0; z-index: 10;">
																			<tr>
																				<th>Date & Time</th>
																				<th>Phone Number</th>
																				<th>Name</th>
																				<th>Barangay</th>
																				<th>Purok</th>
																				<th style="max-width: 300px; min-width: 200px;">Message</th>
																				<th>Status</th>
																			</tr>
																		</thead>
																		<tbody id="smsHistoryTableBody">
																			<tr>
																				<td colspan="7" class="text-center">Loading...</td>
																			</tr>
																		</tbody>
																	</table>
																</div>
                <style>
                    #smsHistoryModal table td:nth-child(6) {
                        max-width: 300px;
                        min-width: 200px;
                        word-wrap: break-word;
                        overflow-wrap: break-word;
                        white-space: normal;
                        line-height: 1.4;
                    }
                </style>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
															
															<!-- View Modal -->
<div class="modal fade" id="viewModal" tabindex="-1" role="dialog" aria-labelledby="viewModalTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewModalTitle">
                    <span id="displayLastName"></span>,
                    <span id="displayFirstName"></span> 
                    <span id="displayMiddleName"></span>
                </h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            
            <div class="modal-body">
                <!-- Top Row: Personal Information + Contact Information -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                    <!-- Left - Personal Information -->
                    <fieldset class="compact-spacing" style="word-wrap: break-word; overflow-wrap: break-word;">
                        <legend>PERSONAL INFORMATION</legend>
                        <p class="compact-spacing" style="word-wrap: break-word; overflow-wrap: break-word; white-space: normal;">
                            <strong>Address:</strong>
                            <span id="displayBarangay"></span> 
                            <span id="displayPurok"></span>
                        </p>
                        <p class="compact-spacing" style="word-wrap: break-word; overflow-wrap: break-word; white-space: normal;">
                            <strong>Birthday:</strong>
                            <span id="displayBirthday"></span> 
                            (<span id="displayAge"></span> years old)
                        </p>
                        <p class="compact-spacing" style="word-wrap: break-word; overflow-wrap: break-word; white-space: normal;">
                            <strong>Gender:</strong>
                            <span id="displayGender"></span>
                        </p>
                        <p class="compact-spacing" style="word-wrap: break-word; overflow-wrap: break-word; white-space: normal;">
                            <strong>Civil Status:</strong>
                            <span id="displayCivilStatus"></span>
                        </p>
                        <p class="compact-spacing" style="word-wrap: break-word; overflow-wrap: break-word; white-space: normal;">
                            <strong>Place of Birth:</strong>
                            <span id="displayPlaceOfBirth"></span>
                        </p>
                        <p id="displaySpouse" class="compact-spacing" style="display: none; word-wrap: break-word; overflow-wrap: break-word; white-space: normal;">
                            <strong>Spouse Name:</strong>
                            <span id="displaySpouseName"></span>
                        </p>
                        <p class="compact-spacing" style="word-wrap: break-word; overflow-wrap: break-word; white-space: normal;">
                            <strong>Father's Name:</strong>
                            <span id="displayFatherName"></span>
                        </p>
                        <p class="no-bottom-margin" style="word-wrap: break-word; overflow-wrap: break-word; white-space: normal;">
                            <strong>Mother's Name:</strong>
                            <span id="displayMotherName"></span>
                        </p>
                    </fieldset>
                    
                    <!-- Right - Contact Information -->
                    <fieldset class="compact-spacing">
                        <legend>CONTACT INFORMATION</legend>
                        <div id="displayContacts">
                            <!-- Contacts will be dynamically inserted here -->
                        </div>
                    </fieldset>
                </div>

                <!-- Middle Row: ID Information + Education -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                    <!-- Left - ID Information -->
                    <fieldset class="compact-spacing">
                        <legend>ID INFORMATION</legend>
                        <p class="compact-spacing">
                            <strong>SSS No:</strong>
                            <span id="displaySSS"></span>
                        </p>
                        <p class="compact-spacing">
                            <strong>GSIS No:</strong>
                            <span id="displayGSIS"></span>
                        </p>
                        <p class="compact-spacing">
                            <strong>PSN No:</strong>
                            <span id="displayPSN"></span>
                        </p>
                        <p class="no-bottom-margin">
                            <strong>Philhealth No:</strong>
                            <span id="displayPhilhealth"></span>
                        </p>
                    </fieldset>
                    
                    <!-- Right - Education Information -->
                    <fieldset class="compact-spacing">
                        <legend>EDUCATION & EMPLOYMENT</legend>
                        <p class="compact-spacing">
                            <strong>Education Level:</strong>
                            <span id="displayEducationLevel"></span>
                        </p>
                        <p class="compact-spacing">
                            <strong>Employment Status:</strong>
                            <span id="displayEmploymentStatus"></span>
                        </p>
                        <p id="displayEmploymentCategory" class="compact-spacing" style="display: none;">
                            <strong>Employment Category:</strong>
                            <span id="displayEmpCategory"></span>
                        </p>
                        <p id="displayEmploymentType" class="no-bottom-margin" style="display: none;">
                            <strong>Employment Type:</strong>
                            <span id="displayEmpType"></span>
                        </p>
                    </fieldset>
                </div>

                <!-- Bottom Row: Disability Information -->
                <fieldset class="no-bottom-margin">
                    <legend>DISABILITY INFORMATION</legend>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <!-- Left - Types of Disability -->
                        <div>
                            <h6 style="margin-bottom: 0.5rem; font-weight: 600; color: #495057;">Types of Disability</h6>
                            <div id="displayDisabilityTypes">
                                <!-- Disability types will be dynamically inserted here -->
                            </div>
                        </div>
                        
                        <!-- Right - Causes of Disability -->
                        <div>
                            <h6 style="margin-bottom: 0.5rem; font-weight: 600; color: #495057;">Causes of Disability</h6>
                            <div id="displayDisabilityCauses">
                                <!-- Disability causes will be dynamically inserted here -->
                            </div>
                        </div>
                    </div>
                </fieldset>
                
                <!-- Edit Log Information -->
                <fieldset class="no-bottom-margin" style="margin-top: 1rem;">
                    <legend>EDIT HISTORY</legend>
                    <div id="displayEditLog">
                        <p class="compact-spacing">
                            <strong>Last Edited By:</strong>
                            <span id="displayEditedBy">N/A</span>
                        </p>
                        <p class="no-bottom-margin">
                            <strong>Last Edited At:</strong>
                            <span id="displayEditedAt">N/A</span>
                        </p>
                    </div>
                </fieldset>
            </div>
            
            <div class="modal-footer flex-footer">
				<button type="button" class="btn btn-outline-primary" id="printApplicationBtn" disabled>
					<i data-feather="printer" style="width: 16px; height: 16px;"></i> Print Application
				</button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
															<!-- Edit Modal -->
															<div class="modal fade" id="editModal" tabindex="-1" role="dialog" aria-labelledby="editModalTitle" aria-hidden="true">
																<div class="modal-dialog modal-dialog-centered modal-xl" role="document">
																	<div class="modal-content">
																		<div class="modal-header">
																			<h5 class="modal-title" id="editModalTitle">Edit PWD Information</h5>
																			<button type="button" class="close" data-dismiss="modal" aria-label="Close">
																				<span aria-hidden="true">&times;</span>
																			</button>
																		</div>

																		<div class="modal-body">
																			<form id="editPwdForm">
																				<input type="hidden" id="editPwdId" name="pwd_id">
																				
																				<!-- Personal Information Section -->
																				<fieldset class="mb-4">
																					<legend>Personal Information</legend>
																					<div class="row">
																						<div class="col-md-4">
																							<div class="form-group">
																								<label for="editFirstName">First Name *</label>
																								<input type="text" class="form-control" id="editFirstName" name="first_name" required>
																					</div>
																			</div>
																						<div class="col-md-4">
																							<div class="form-group">
																								<label for="editMiddleName">Middle Name</label>
																								<input type="text" class="form-control" id="editMiddleName" name="middle_name">
																							</div>
																						</div>
																						<div class="col-md-4">
																							<div class="form-group">
																								<label for="editLastName">Last Name *</label>
																								<input type="text" class="form-control" id="editLastName" name="last_name" required>
																							</div>
																						</div>
																					</div>
																					<div class="row">
																						<div class="col-md-3">
																							<div class="form-group">
																								<label for="editBirthday">Birthday *</label>
																								<input type="date" class="form-control" id="editBirthday" name="birthday" required>
																							</div>
																						</div>
																						<div class="col-md-3">
																							<div class="form-group">
																								<label for="editAge">Age</label>
																								<input type="number" class="form-control" id="editAge" name="age" readonly>
																							</div>
																						</div>
																						<div class="col-md-3">
																							<div class="form-group">
																								<label for="editGender">Gender *</label>
																								<select class="form-control" id="editGender" name="gender" required>
																									<option value="">Select Gender</option>
																									<option value="Male">Male</option>
																									<option value="Female">Female</option>
																									<option value="Other">Other</option>
																									<option value="Prefer not to say">Prefer not to say</option>
																								</select>
																							</div>
																						</div>
																						<div class="col-md-3">
																							<div class="form-group">
																								<label for="editCivilStatus">Civil Status *</label>
																								<select class="form-control" id="editCivilStatus" name="civil_status" required>
																									<option value="">Select Status</option>
																									<option value="Single">Single</option>
																									<option value="Single but Head of the Family">Single but Head of the Family</option>
																									<option value="Married">Married</option>
																								</select>
																							</div>
																						</div>
																					</div>
																					<div class="row">
																						<div class="col-md-4">
																							<div class="form-group">
																								<label for="editBarangay">Barangay *</label>
																								<input type="text" class="form-control" id="editBarangay" name="barangay" required>
																							</div>
																						</div>
																						<div class="col-md-4">
																							<div class="form-group">
																								<label for="editPurok">Purok</label>
																								<input type="text" class="form-control" id="editPurok" name="purok">
																							</div>
																						</div>
																						<div class="col-md-4">
																							<div class="form-group">
																								<label for="editPlaceOfBirth">Place of Birth</label>
																								<input type="text" class="form-control" id="editPlaceOfBirth" name="place_of_birth">
																							</div>
																						</div>
																					</div>
																					<div class="row" id="editSpouseRow" style="display: none;">
																						<div class="col-md-12">
																							<div class="form-group">
																								<label for="editSpouseName">Spouse Name</label>
																								<input type="text" class="form-control" id="editSpouseName" name="spouse_name">
																							</div>
																						</div>
																					</div>
																				</fieldset>
																				
																				<!-- Parent Information Section -->
																				<fieldset class="mb-4">
																					<legend>Parent Information</legend>
																					<div class="row">
																						<div class="col-md-3">
																							<div class="form-group">
																								<label for="editFatherFirstName">Father's First Name</label>
																								<input type="text" class="form-control" id="editFatherFirstName" name="fatherFirstName">
																							</div>
																						</div>
																						<div class="col-md-3">
																							<div class="form-group">
																								<label for="editFatherMiddleName">Father's Middle Name</label>
																								<input type="text" class="form-control" id="editFatherMiddleName" name="fatherMiddleName">
																							</div>
																						</div>
																						<div class="col-md-3">
																							<div class="form-group">
																								<label for="editFatherLastName">Father's Last Name</label>
																								<input type="text" class="form-control" id="editFatherLastName" name="fatherLastName">
																							</div>
																						</div>
																						<div class="col-md-3">
																							<div class="form-group">
																								<label for="editFatherExtension">Father's Extension</label>
																								<input type="text" class="form-control" id="editFatherExtension" name="fatherExtension">
																							</div>
																						</div>
																					</div>
																					<div class="row">
																						<div class="col-md-4">
																							<div class="form-group">
																								<label for="editMotherFirstName">Mother's First Name</label>
																								<input type="text" class="form-control" id="editMotherFirstName" name="motherFirstName">
																							</div>
																						</div>
																						<div class="col-md-4">
																							<div class="form-group">
																								<label for="editMotherMiddleName">Mother's Middle Name</label>
																								<input type="text" class="form-control" id="editMotherMiddleName" name="motherMiddleName">
																							</div>
																						</div>
																						<div class="col-md-4">
																							<div class="form-group">
																								<label for="editMotherLastName">Mother's Last Name</label>
																								<input type="text" class="form-control" id="editMotherLastName" name="motherLastName">
																							</div>
																						</div>
																			</div>
																				</fieldset>
																				
																				<!-- ID Information Section -->
																				<fieldset class="mb-4">
																					<legend>ID Information</legend>
																					<div class="row">
																						<div class="col-md-3">
																							<div class="form-group">
																								<label for="editSSS">SSS No.</label>
																								<input type="text" class="form-control" id="editSSS" name="sss_id">
																			</div>
																						</div>
																						<div class="col-md-3">
																							<div class="form-group">
																								<label for="editGSIS">GSIS No.</label>
																								<input type="text" class="form-control" id="editGSIS" name="gsis_sss_no">
																							</div>
																						</div>
																						<div class="col-md-3">
																							<div class="form-group">
																								<label for="editPSN">PSN No.</label>
																								<input type="text" class="form-control" id="editPSN" name="psn_no">
																							</div>
																						</div>
																						<div class="col-md-3">
																							<div class="form-group">
																								<label for="editPhilhealth">Philhealth No.</label>
																								<input type="text" class="form-control" id="editPhilhealth" name="philhealth_no">
																							</div>
																						</div>
																					</div>
																				</fieldset>

																				<!-- Education & Employment Section -->
																				<fieldset class="mb-4">
																					<legend>Education & Employment</legend>
																					<div class="row">
																						<div class="col-md-6">
																							<div class="form-group">
																								<label for="editEducationLevel">Education Level</label>
																								<select class="form-control" id="editEducationLevel" name="education_level">
																									<option value="">Select Education Level</option>
																									<option value="Not Attended School">Not Attended School</option>
																									<option value="Elementary Level">Elementary Level</option>
																									<option value="Elementary Graduate">Elementary Graduate</option>
																									<option value="High School Graduate">High School Graduate</option>
																									<option value="College Level">College Level</option>
																									<option value="College Graduate">College Graduate</option>
																									<option value="Post Graduate">Post Graduate</option>
																									<option value="Vocational">Vocational</option>
																								</select>
																						</div>
																					</div>
																						<div class="col-md-6">
																							<div class="form-group">
																								<label for="editEmploymentStatus">Employment Status</label>
																								<select class="form-control" id="editEmploymentStatus" name="employment_status">
																									<option value="">Select Employment Status</option>
																									<option value="Employee">Employee</option>
																									<option value="Unemployed">Unemployed</option>
																									<option value="Self-employed">Self-employed</option>
																								</select>
																							</div>
																						</div>
																					</div>
																					<div class="row" id="editEmploymentDetails" style="display: none;">
																						<div class="col-md-6">
																							<div class="form-group">
																								<label for="editEmploymentCategory">Employment Category</label>
																								<select class="form-control" id="editEmploymentCategory" name="employment_category">
																									<option value="">Select Category</option>
																									<option value="Government">Government</option>
																									<option value="Private">Private</option>
																								</select>
																							</div>
																						</div>
																						<div class="col-md-6">
																							<div class="form-group">
																								<label for="editEmploymentType">Employment Type</label>
																								<select class="form-control" id="editEmploymentType" name="employment_type">
																									<option value="">Select Type</option>
																									<option value="Permanent/Regular">Permanent/Regular</option>
																									<option value="Seasonal">Seasonal</option>
																									<option value="Casual">Casual</option>
																									<option value="Emergency">Emergency</option>
																								</select>
																							</div>
																						</div>
																					</div>
																				</fieldset>

																				<!-- Disability Information Section -->
																				<fieldset class="mb-4">
																					<legend>Disability Information</legend>
																					<div class="row">
																						<div class="col-md-6">
																							<h6>Types of Disability</h6>
																							<div id="editDisabilityTypes">
																								<!-- Disability checkboxes will be populated here -->
																							</div>
																						</div>
																						<div class="col-md-6">
																							<h6>Causes of Disability</h6>
																							<div id="editDisabilityCauses">
																								<!-- Disability causes checkboxes will be populated here -->
																						</div>
																					</div>
																				</div>
																			</fieldset>
																					
																			</form>
																				</div>
																				<div class="modal-footer">
																					<button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
																			<button type="button" class="btn btn-primary" id="updatePwdBtn">Update</button>
																		</div>
																	</div>
																</div>
															</div>
														</td>
													</tr><% }); %> </tbody>
											</table>
											<!-- Button to open SMS modal for selected rows -->
											<div class="mt-3">
												<button id="openSmsForSelected" class="btn btn-success" disabled>
													<i data-feather="message-circle"></i> Send SMS to selected
												</button>
												<button id="viewSmsHistoryBtn" class="btn btn-info ml-2">
													<i data-feather="clock"></i> View SMS History
												</button>
											</div>
											<% } else { %> <div class="alert alert-info text-center"> No data found. </div><% } %>
										</div>
										<!-- Container div -->
									</div>
								</div>
							</div>
						</div>
					</div>
					<div id="styleSelector"></div>
				</div>
			</div>
		</div>
		</div>
		</div>
		</div>
		</div>
		</div>
		<script type="application/json" id="barangays-json"><%- JSON.stringify(barangays || {}).replace(/<\/script/gi, '<\\/script') %></script>
		<script type="application/json" id="pwds-json"><%- JSON.stringify(pwds || []).replace(/<\/script/gi, '<\\/script') %></script>
		<script>
			// Convert EJS data to JavaScript objects
			const barangaysData = JSON.parse(document.getElementById('barangays-json').textContent || '{}');
			const pwdsData = JSON.parse(document.getElementById('pwds-json').textContent || '[]');
			
			// Wait for DOM to be fully loaded
			document.addEventListener('DOMContentLoaded', function() {
				console.log('DOM loaded - initializing Generate Report button');

				const printApplicationBtn = document.getElementById('printApplicationBtn');

				if (printApplicationBtn) {
					printApplicationBtn.addEventListener('click', function() {
						const recordId = this.dataset.pwdId;
						if (!recordId) {
							alert('Please open a PWD record before printing.');
							return;
						}

						const pdfUrl = `/pwd/${recordId}/application-pdf`;
						const pdfWindow = window.open(pdfUrl, '_blank', 'noopener');
						if (!pdfWindow) {
							alert('Popup blocked! Please allow popups to view the PDF.');
						}
					});
				}
				
				// Initialize Generate Report Button - FIXED VERSION
				const generateReportBtn = document.getElementById('generateReportBtn');
				
				if (generateReportBtn) {
					console.log('Generate Report button found, adding event listener');
					
					generateReportBtn.addEventListener('click', function() {
						console.log('Generate Report button clicked');
						
						try {
							// Build the report table HTML
							const tableHtml = buildPwdsReportTableHtml(pwdsData);
							
							// Open new window for report
							const newWin = window.open('', '_blank', 'width=1200,height=800,scrollbars=yes');
							
							if (!newWin) {
								alert('Popup blocked! Please allow popups for this site to view the report.');
								return;
							}
							
							const docHtml = `<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>PWD Disability Report</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <link rel="stylesheet" href="/bower_components/bootstrap/css/bootstrap.min.css">
    <style>
        body { padding: 30px; font-family: Arial, sans-serif; }

        .header-wrapper {
            position: relative;
            margin-bottom: 20px;
            min-height: 130px;
        }

        .logo-left {
            position: absolute;
            top: 0;
            left: 0;
            width: 95px;
        }

        .logo-right {
            position: absolute;
            top: 0;
            right: 0;
            width: 120px;
        }

        .main-header {
            text-align: center;
            margin-top: 15px;
        }

        .title-section { 
            margin-top: 15px; 
            text-align: center;
        }

        .report-info {
            margin: 20px auto;
            text-align: center;
            font-size: 13px;
            line-height: 1.8;
            max-width: 800px;
            white-space: nowrap;
        }

        .info-item {
            display: inline-block;
            margin: 0 15px;
        }

        .underline {
            display: inline-block;
            border-bottom: 1px solid #000;
            width: 120px;
            height: 14px;
            vertical-align: bottom;
            margin-left: 5px;
        }

        .address-underline {
            width: 150px;
        }

        .generated-date {
            margin-top: 10px;
            font-style: italic;
        }
    </style>
</head>

<body>

<div class="container">
	  <div class="text-center generated-date">
        <p><strong>Generated:</strong> ${new Date().toLocaleString()}</p>
    </div>
	
    <div class="header-wrapper">
        <img src="/assets/images/SilayLogo.jpg" class="logo-left">
        <img src="/assets/images/BagongPilipinas.jpg" class="logo-right">

        <div class="main-header">
            <h4>Republic of the Philippines</h4>
            <h2><strong>SILAY CITY GOVERNMENT</strong></h2>
            <p>Persons with Disability Affairs Office</p>
        </div>
    </div>

    <div class="title-section">
        <h5>PERSONS WITH DISABILITY AFFAIRS OFFICE</h5>
        <h5>ANNUAL ACCOMPLISHMENT REPORT</h5>
    </div>

    <div class="report-info">
        <span class="info-item">Region: <span class="underline"></span></span>
        <span class="info-item">Persons with Disability Statistics: <span class="underline"></span></span>
        <span class="info-item">Address: <span class="underline address-underline"></span></span>
    </div>

  

    ${tableHtml}

</div>

</body>
</html>`;



							
							newWin.document.open();
							newWin.document.write(docHtml);
							newWin.document.close();
							
							console.log('Report generated successfully');
							
						} catch (e) {
							console.error('Error generating report:', e);
							alert('Error generating report: ' + e.message);
						}
					});
				} else {
					console.error('Generate Report button not found in DOM!');
				}

				// Build table HTML for report - FIXED FUNCTION
				function buildPwdsReportTableHtml(pwds) {
					function esc(s){ 
						return String(s === null || s === undefined ? '' : s)
							.replace(/&/g,'&amp;')
							.replace(/</g,'&lt;')
							.replace(/>/g,'&gt;'); 
					}
					
					const mapping = {
						'Hard of Hearing/Deaf': 'Deaf or Hard of Hearing',
						'Visual/Blind': 'Visual Disability',
						'Speech/Language Impairment': 'Speech and Language Impairment',
						'Learning Disability': 'Learning Disability',
						'Mental/Intellectual': 'Intellectual Disability',
						'Physical Disability': 'Physical Disability (Orthopedic)',
						'Psychosocial Disability': 'Psychosocial Disability',
						'Cancer': 'Cancer (RA11215)',
						'Rare Disease': 'Rare Disease (RA10747)',
						'Multiple Disability': 'Multiple Disability',
						'Other': 'Other'
					};
					
					const stats = {};
					const uniqueIds = new Set();
					
					// Process PWD data
					pwds.forEach(p => {
						if (p && (p._id || p.id)) uniqueIds.add(p._id || p.id);
						const age = (typeof p.age === 'number') ? p.age : (p.age ? parseInt(p.age,10) : null);
						const gender = (p.gender || 'Unknown').toString();
						const disabilities = Array.isArray(p.disability) ? p.disability : (p.disability ? [p.disability] : []);
						
						disabilities.forEach(d => {
							const key = mapping[d] || d || 'Other';
							if (!stats[key]) {
								stats[key] = { 
									count: 0, 
									male: 0, 
									female: 0, 
									otherGender: 0, 
									ages: [] 
								};
							}
							stats[key].count += 1;
							if (age !== null && !isNaN(age)) stats[key].ages.push(age);
							if (/^male$/i.test(gender)) stats[key].male += 1;
							else if (/^female$/i.test(gender)) stats[key].female += 1;
							else stats[key].otherGender += 1;
						});
					});

					const preferredOrder = [
						'Deaf or Hard of Hearing', 'Intellectual Disability', 'Learning Disability', 
						'Mental Disability', 'Physical Disability (Orthopedic)', 'Psychosocial Disability', 
						'Speech and Language Impairment', 'Visual Disability', 'Cancer (RA11215)', 
						'Rare Disease (RA10747)', 'Multiple Disability', 'Other'
					];
					
					const keys = Array.from(new Set([...preferredOrder, ...Object.keys(stats)]));
					let html = `
						<div class="table-responsive">
							<table class="table table-striped table-bordered table-hover">
								<thead class="table-dark">
									<tr>
										<th>Disability Type</th>
										<th>Age Range</th>
										<th>Total</th>
										<th>Male</th>
										<th>Female</th>
										<th>Other/Unknown</th>
									</tr>
								</thead>
								<tbody>`;
					
					keys.forEach(k => {
						if (!stats[k]) return;
						const s = stats[k];
						const minAge = s.ages.length ? Math.min(...s.ages) : 'N/A';
						const maxAge = s.ages.length ? Math.max(...s.ages) : 'N/A';
						const ageRange = s.ages.length ? `${minAge} - ${maxAge}` : 'N/A';
						
						html += `
							<tr>
								<td><strong>${esc(k)}</strong></td>
								<td>${esc(ageRange)}</td>
								<td><span class="badge bg-primary">${s.count}</span></td>
								<td>${s.male}</td>
								<td>${s.female}</td>
								<td>${s.otherGender}</td>
							</tr>`;
					});
					
					html += '</tbody></table></div>';
					
					// Calculate totals
					let totalMale = 0, totalFemale = 0, totalOther = 0, totalCount = 0;
					Object.values(stats).forEach(s => { 
						totalMale += s.male; 
						totalFemale += s.female; 
						totalOther += s.otherGender;
						totalCount += s.count;
					});
					
					const allAges = [].concat(...Object.values(stats).map(s => s.ages));
					const overallAgeRange = allAges.length ? 
						`${Math.min(...allAges)} - ${Math.max(...allAges)}` : 'N/A';
					
					html += `
						<div class="summary">
							<hr>
							<h5>Report Summary</h5>
							<div class="row">
								<div class="col-md-6">
									<ul class="list-unstyled">
										<li><strong>Unique PWDs:</strong> ${uniqueIds.size}</li>
										<li><strong>Total Disability Records:</strong> ${totalCount}</li>
										<li><strong>Overall Age Range:</strong> ${overallAgeRange}</li>
									</ul>
								</div>
								<div class="col-md-6">
									<ul class="list-unstyled">
										<li><strong>Gender Distribution:</strong></li>
										<li>&nbsp;&nbsp;Male: ${totalMale}</li>
										<li>&nbsp;&nbsp;Female: ${totalFemale}</li>
										<li>&nbsp;&nbsp;Other/Unknown: ${totalOther}</li>
									</ul>
								</div>
							</div>
						</div>`;
					
					return html;
				}

				// Your existing code for other functionality...
				// Get select elements
				const barangaySelect = document.getElementById('barangay-filter');
				const purokSelect = document.getElementById('purok-filter');
				const statusFilter = document.getElementById('status-filter');
				
				// Set initial status filter value based on URL parameter
				const urlParams = new URLSearchParams(window.location.search);
				const statusParam = urlParams.get('status');
				if (statusParam === 'all') {
					statusFilter.value = 'all';
				} else if (statusParam === 'archived') {
					statusFilter.value = 'archived';
				} else {
					statusFilter.value = 'active';
				}
				
				// Status filter change event handler
				statusFilter.addEventListener('change', function() {
					const selectedStatus = this.value;
					const url = new URL(window.location.href);
					
					if (selectedStatus === 'active') {
						url.searchParams.delete('status');
					} else if (selectedStatus === 'archived') {
						url.searchParams.set('status', 'archived');
					} else {
						url.searchParams.set('status', 'all');
					}
					
					window.location.href = url.toString();
				});
				
				// Initialize DataTable with filtering capability
				var table = $('#example').DataTable({
					paging: true,
					pageLength: 10,
					lengthMenu: [5, 10, 25, 50, 100],
					responsive: true,
					columnDefs: [
						{
							targets: 0, // First column (checkbox column)
							searchable: false,
							orderable: false
						}
					],
					order: [[1, 'asc']], // Sort by second column (Full Name) by default
					rowCallback: function(row) {
						if ($(row).hasClass('dt-empty')) {
							$(row).hide();
						}
					}
				});

				// Select All functionality
				$('#select-all').on('click', function() {
					const isChecked = $(this).prop('checked');
					// Select/deselect all visible rows on current page
					table.rows({ page: 'current' }).nodes().to$().find('.row-checkbox').prop('checked', isChecked);
					// Update the SMS button state
					const openSmsBtn = document.getElementById('openSmsForSelected');
					if (openSmsBtn) {
						const anyChecked = Array.from(document.querySelectorAll('.row-checkbox')).some(cb => cb.checked);
						openSmsBtn.disabled = !anyChecked;
					}
				});

				// Update select-all checkbox state when individual checkboxes change
				$(document).on('change', '.row-checkbox', function() {
					const totalVisible = table.rows({ page: 'current' }).nodes().to$().find('.row-checkbox').length;
					const checkedVisible = table.rows({ page: 'current' }).nodes().to$().find('.row-checkbox:checked').length;
					$('#select-all').prop('checked', totalVisible > 0 && totalVisible === checkedVisible);
					// Update the SMS button state
					const openSmsBtn = document.getElementById('openSmsForSelected');
					if (openSmsBtn) {
						const anyChecked = Array.from(document.querySelectorAll('.row-checkbox')).some(cb => cb.checked);
						openSmsBtn.disabled = !anyChecked;
					}
				});

				// Update select-all state when table is redrawn (pagination, filtering, etc.)
				table.on('draw', function() {
					const totalVisible = table.rows({ page: 'current' }).nodes().to$().find('.row-checkbox').length;
					const checkedVisible = table.rows({ page: 'current' }).nodes().to$().find('.row-checkbox:checked').length;
					$('#select-all').prop('checked', totalVisible > 0 && totalVisible === checkedVisible);
				});

				// Initialize purok dropdown as disabled
				purokSelect.disabled = true;

				// Barangay change event handler
				barangaySelect.addEventListener('change', function() {
					const selectedBarangay = this.value;
					purokSelect.innerHTML = '';
					
					const defaultOption = document.createElement('option');
					defaultOption.value = '';
					defaultOption.textContent = 'Select Purok';
					purokSelect.appendChild(defaultOption);
					
					purokSelect.disabled = !selectedBarangay;
					
					if (selectedBarangay && barangaysData[selectedBarangay]) {
						const allOption = document.createElement('option');
						allOption.value = 'all';
						allOption.textContent = 'All Puroks';
						purokSelect.appendChild(allOption);
						
						barangaysData[selectedBarangay].forEach(purok => {
							const option = document.createElement('option');
							option.value = purok;
							option.textContent = purok;
							purokSelect.appendChild(option);
						});
					}
					
					// Filter the table based on selected barangay
					if (selectedBarangay === '') {
						table.columns(3).search('').draw(); // Changed from 2 to 3
					} else {
						table.columns(3).search(selectedBarangay).draw(); // Changed from 2 to 3
					}
				});

				// Purok change event handler
				purokSelect.addEventListener('change', function() {
					const selectedPurok = this.value;
					const selectedBarangay = barangaySelect.value;
					
					if (selectedPurok === 'all') {
						// Show all puroks in selected barangay
						table.columns(4).search('').draw(); // Changed from 3 to 4
					} else if (selectedPurok === '') {
						// Show all records in selected barangay (no purok filter)
						table.columns(4).search('').draw(); // Changed from 3 to 4
					} else {
						// Filter by specific purok
						table.columns(4).search(selectedPurok).draw(); // Changed from 3 to 4
					}
				});

				// VIEW MODAL CODE - FIXED VERSION
				console.log('Initializing view buttons...');
				const viewButtons = document.querySelectorAll('.view-btn');
				console.log(`Found ${viewButtons.length} view buttons`);
				
				viewButtons.forEach(button => {
					button.addEventListener('click', function() {
						console.log('View button clicked');
						try {
							const pwdData = JSON.parse(this.getAttribute('data-pwd').replace(/&apos;/g, "'"));
							console.log('PWD Data loaded:', pwdData);

							const recordId = pwdData._id || pwdData.id || this.getAttribute('data-pwd-id');
							if (printApplicationBtn) {
								if (recordId) {
									printApplicationBtn.dataset.pwdId = recordId;
									printApplicationBtn.removeAttribute('disabled');
								} else {
									printApplicationBtn.dataset.pwdId = '';
									printApplicationBtn.setAttribute('disabled', 'disabled');
								}
							}
							
							// Basic Information
							document.getElementById('displayFirstName').textContent = pwdData.first_name || 'N/A';
							document.getElementById('displayMiddleName').textContent = pwdData.middle_name || '';
							document.getElementById('displayLastName').textContent = pwdData.last_name || 'N/A';
							
							// Address Information
							document.getElementById('displayBarangay').textContent = pwdData.barangay || 'N/A';
							document.getElementById('displayPurok').textContent = pwdData.purok || 'N/A';
							
							// Personal Information
							document.getElementById('displayBirthday').textContent = pwdData.birthday ? new Date(pwdData.birthday).toLocaleDateString() : 'N/A';
							document.getElementById('displayAge').textContent = pwdData.age || 'N/A';
							document.getElementById('displayGender').textContent = pwdData.gender || 'N/A';
							document.getElementById('displayCivilStatus').textContent = pwdData.civil_status || 'N/A';
							document.getElementById('displayPlaceOfBirth').textContent = pwdData.place_of_birth || 'N/A';
							
							// Spouse Information
							if (pwdData.civil_status === 'Married' && pwdData.spouse_name) {
								document.getElementById('displaySpouse').style.display = 'block';
								document.getElementById('displaySpouseName').textContent = pwdData.spouse_name;
							} else {
								document.getElementById('displaySpouse').style.display = 'none';
							}
							
							// Parent Information
							const fatherName = `${pwdData.fatherFirstName || ''} ${pwdData.fatherMiddleName || ''} ${pwdData.fatherLastName || ''} ${pwdData.fatherExtension || ''}`.trim();
							const motherName = `${pwdData.motherFirstName || ''} ${pwdData.motherMiddleName || ''} ${pwdData.motherLastName || ''}`.trim();
							
							document.getElementById('displayFatherName').textContent = fatherName || 'N/A';
							document.getElementById('displayMotherName').textContent = motherName || 'N/A';
							
							// Contact Information
							const contactsContainer = document.getElementById('displayContacts');
							contactsContainer.innerHTML = '';
							
							if (pwdData.contacts && pwdData.contacts.length > 0) {
								pwdData.contacts.forEach(contact => {
									const contactElement = document.createElement('div');
									contactElement.className = 'contact-item';
									contactElement.innerHTML = `
										<p><strong>${contact.type ? contact.type.toUpperCase() : 'CONTACT'}:</strong></p>
										<p>Name: ${contact.name || 'N/A'}</p>
										<p>Relationship: ${contact.relationship || 'N/A'}</p>
										<p>Phone: ${contact.phone || 'N/A'}</p>
										${contact.email ? `<p>Email: ${contact.email}</p>` : ''}
										<hr>
									`;
									contactsContainer.appendChild(contactElement);
								});
							} else {
								contactsContainer.innerHTML = '<p>No contact information available</p>';
							}
							
							// ID Information
							document.getElementById('displaySSS').textContent = pwdData.sss_id || 'N/A';
							document.getElementById('displayGSIS').textContent = pwdData.gsis_sss_no || 'N/A';
							document.getElementById('displayPSN').textContent = pwdData.psn_no || 'N/A';
							document.getElementById('displayPhilhealth').textContent = pwdData.philhealth_no || 'N/A';
							
							// Education and Employment
							document.getElementById('displayEducationLevel').textContent = pwdData.education_level || 'N/A';
							document.getElementById('displayEmploymentStatus').textContent = pwdData.employment_status || 'N/A';
							
							if (pwdData.employment_status === 'Employee') {
								document.getElementById('displayEmploymentCategory').style.display = 'block';
								document.getElementById('displayEmploymentType').style.display = 'block';
								document.getElementById('displayEmpCategory').textContent = pwdData.employment_category || 'N/A';
								document.getElementById('displayEmpType').textContent = pwdData.employment_type || 'N/A';
							} else {
								document.getElementById('displayEmploymentCategory').style.display = 'none';
								document.getElementById('displayEmploymentType').style.display = 'none';
							}
							
							// Disability Information
							const disabilityTypesContainer = document.getElementById('displayDisabilityTypes');
							disabilityTypesContainer.innerHTML = '';
							
							if (pwdData.disability && pwdData.disability.length > 0) {
								pwdData.disability.forEach(type => {
									const typeElement = document.createElement('p');
									typeElement.textContent = type || 'N/A';
									if (type === 'Other' && pwdData.disability_other_text) {
										typeElement.textContent += ` (${pwdData.disability_other_text})`;
									}
									disabilityTypesContainer.appendChild(typeElement);
								});
							} else {
								disabilityTypesContainer.innerHTML = '<p>No disability types specified</p>';
							}
							
							// Causes of Disability
							const disabilityCausesContainer = document.getElementById('displayDisabilityCauses');
							disabilityCausesContainer.innerHTML = '';
							
							if (pwdData.cause_disability && pwdData.cause_disability.length > 0) {
								pwdData.cause_disability.forEach(cause => {
									const causeElement = document.createElement('p');
									causeElement.textContent = cause || 'N/A';
									if (cause === 'Other' && pwdData.cause_other_text) {
										causeElement.textContent += ` (${pwdData.cause_other_text})`;
									}
									disabilityCausesContainer.appendChild(causeElement);
								});
							} else {
								disabilityCausesContainer.innerHTML = '<p>No causes specified</p>';
							}
							
							// Edit Log Information
							if (pwdData.edit_log && pwdData.edit_log.edited_by) {
								document.getElementById('displayEditedBy').textContent = pwdData.edit_log.edited_by || 'N/A';
								if (pwdData.edit_log.edited_at) {
									const editDate = new Date(pwdData.edit_log.edited_at);
									document.getElementById('displayEditedAt').textContent = editDate.toLocaleString();
								} else {
									document.getElementById('displayEditedAt').textContent = 'N/A';
								}
							} else {
								document.getElementById('displayEditedBy').textContent = 'N/A';
								document.getElementById('displayEditedAt').textContent = 'N/A';
							}
							
							// Show the modal using jQuery (since we're using Bootstrap 4)
							$('#viewModal').modal('show');
							console.log('View modal should be shown now');
							
						} catch (e) {
							console.error('Error parsing PWD data:', e);
							alert('Error loading PWD data: ' + e.message);
						}
					});
				});

				// Add cleanup handler for view modal to remove backdrop
				$('#viewModal').on('hidden.bs.modal', function () {
					// Remove any leftover backdrop elements
					$('.modal-backdrop').remove();
					// Remove modal-open class from body
					$('body').removeClass('modal-open');
					// Remove inline styles that might block interaction
					$('body').css('padding-right', '');
					if (printApplicationBtn) {
						printApplicationBtn.dataset.pwdId = '';
						printApplicationBtn.setAttribute('disabled', 'disabled');
					}
				});

				// EDIT MODAL CODE - FIXED VERSION
				const editButtons = document.querySelectorAll('.edit-btn');
				
				// Define disability types and causes for checkbox generation
				const disabilityTypes = [
					'Deaf or Hard of Hearing',
					'Intellectual Disability',
					'Learning Disability',
					'Mental Disability',
					'Physical Disability (Orthopedic)',
					'Psychosocial Disability',
					'Speech and Language Impairment',
					'Visual Disability',
					'Cancer (RA11215)',
					'Rare Disease (RA10747)',
					'Other'
				];

				const disabilityCauses = [
					'Congenital / Inborn',
					'Autism',
					'ADHD',
					'Cerebral Palsy',
					'Down Syndrome',
					'Acquired',
					'Chronic Illness',
					'Injury',
					'Other'
				];

				// Function to populate disability checkboxes
				function populateDisabilityCheckboxes(containerId, options, selectedValues, otherTextValue) {
					const container = document.getElementById(containerId);
					if (!container) return;
					
					container.innerHTML = '';
					
					options.forEach(option => {
						const div = document.createElement('div');
						div.className = 'form-check mb-2';
						
						const checkbox = document.createElement('input');
						checkbox.type = 'checkbox';
						checkbox.className = 'form-check-input';
						checkbox.id = `${containerId}-${option.replace(/\s+/g, '-').toLowerCase()}`;
						checkbox.value = option;
						checkbox.name = containerId === 'editDisabilityTypes' ? 'disability[]' : 'cause_disability[]';
						
						// Check if this option is selected
						if (selectedValues && Array.isArray(selectedValues) && selectedValues.includes(option)) {
							checkbox.checked = true;
						}
						
						const label = document.createElement('label');
						label.className = 'form-check-label';
						label.htmlFor = checkbox.id;
						label.textContent = option;
						
						div.appendChild(checkbox);
						div.appendChild(label);
						
						// Add text input for "Other" option
						if (option === 'Other') {
							const textInput = document.createElement('input');
							textInput.type = 'text';
							textInput.className = 'form-control mt-2';
							textInput.placeholder = 'Please specify';
							textInput.name = containerId === 'editDisabilityTypes' ? 'disability_other_text' : 'cause_other_text';
							if (otherTextValue) {
								textInput.value = otherTextValue;
							}
							div.appendChild(textInput);
						}
						
						container.appendChild(div);
					});
				}

				editButtons.forEach(button => {
					button.addEventListener('click', function() {
						try {
							const pwdData = JSON.parse(this.getAttribute('data-pwd').replace(/&apos;/g, "'"));
							console.log('Edit PWD Data:', pwdData);
							
							// Helper function to format date for input[type="date"]
							function formatDateForInput(dateValue) {
								if (!dateValue) return '';
								let date;
								if (dateValue instanceof Date) {
									date = dateValue;
								} else if (typeof dateValue === 'string') {
									date = new Date(dateValue);
								} else {
									return '';
								}
								if (isNaN(date.getTime())) return '';
								const year = date.getFullYear();
								const month = String(date.getMonth() + 1).padStart(2, '0');
								const day = String(date.getDate()).padStart(2, '0');
								return `${year}-${month}-${day}`;
							}
							
							// No normalization needed - use original values from database
							
							// Populate form fields
							document.getElementById('editPwdId').value = pwdData._id || pwdData.id || '';
							document.getElementById('editFirstName').value = pwdData.first_name || '';
							document.getElementById('editMiddleName').value = pwdData.middle_name || '';
							document.getElementById('editLastName').value = pwdData.last_name || '';
							
							// Handle birthday - try multiple formats
							const birthdayValue = formatDateForInput(pwdData.birthday);
							document.getElementById('editBirthday').value = birthdayValue;
							
							// Calculate age if birthday is set but age is missing
							if (birthdayValue && !pwdData.age) {
								const birthday = new Date(pwdData.birthday);
								const today = new Date();
								let age = today.getFullYear() - birthday.getFullYear();
								const monthDiff = today.getMonth() - birthday.getMonth();
								if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthday.getDate())) {
									age--;
								}
								document.getElementById('editAge').value = age;
							} else {
								document.getElementById('editAge').value = pwdData.age || '';
							}
							
							// Gender - handle all possible values
							const genderSelect = document.getElementById('editGender');
							const genderValue = pwdData.gender || '';
							genderSelect.value = genderValue;
							// If value doesn't exist in options, add it
							if (genderValue && !Array.from(genderSelect.options).some(opt => opt.value === genderValue)) {
								const option = document.createElement('option');
								option.value = genderValue;
								option.textContent = genderValue;
								genderSelect.appendChild(option);
								genderSelect.value = genderValue;
							}
							
							// Civil Status - use original value
							const civilStatusSelect = document.getElementById('editCivilStatus');
							civilStatusSelect.value = pwdData.civil_status || '';
							// If value doesn't exist in options, add it
							if (pwdData.civil_status && !Array.from(civilStatusSelect.options).some(opt => opt.value === pwdData.civil_status)) {
								const option = document.createElement('option');
								option.value = pwdData.civil_status;
								option.textContent = pwdData.civil_status;
								civilStatusSelect.appendChild(option);
								civilStatusSelect.value = pwdData.civil_status;
							}
							
							document.getElementById('editBarangay').value = pwdData.barangay || '';
							document.getElementById('editPurok').value = pwdData.purok || '';
							document.getElementById('editPlaceOfBirth').value = pwdData.place_of_birth || '';
							document.getElementById('editSpouseName').value = pwdData.spouse_name || '';
							
							// Show/hide spouse field based on civil status
							const spouseRow = document.getElementById('editSpouseRow');
							if (pwdData.civil_status === 'Married') {
								spouseRow.style.display = 'block';
							} else {
								spouseRow.style.display = 'none';
							}
							
							// Parent information
							document.getElementById('editFatherFirstName').value = pwdData.fatherFirstName || '';
							document.getElementById('editFatherMiddleName').value = pwdData.fatherMiddleName || '';
							document.getElementById('editFatherLastName').value = pwdData.fatherLastName || '';
							document.getElementById('editFatherExtension').value = pwdData.fatherExtension || '';
							document.getElementById('editMotherFirstName').value = pwdData.motherFirstName || '';
							document.getElementById('editMotherMiddleName').value = pwdData.motherMiddleName || '';
							document.getElementById('editMotherLastName').value = pwdData.motherLastName || '';
							
							// ID Information
							document.getElementById('editSSS').value = pwdData.sss_id || '';
							document.getElementById('editGSIS').value = pwdData.gsis_sss_no || '';
							document.getElementById('editPSN').value = pwdData.psn_no || '';
							document.getElementById('editPhilhealth').value = pwdData.philhealth_no || '';
							
							// Education and Employment
							document.getElementById('editEducationLevel').value = pwdData.education_level || '';
							
							// Employment Status - use original value
							const employmentStatusSelect = document.getElementById('editEmploymentStatus');
							employmentStatusSelect.value = pwdData.employment_status || '';
							// If value doesn't exist in options, add it
							if (pwdData.employment_status && !Array.from(employmentStatusSelect.options).some(opt => opt.value === pwdData.employment_status)) {
								const option = document.createElement('option');
								option.value = pwdData.employment_status;
								option.textContent = pwdData.employment_status;
								employmentStatusSelect.appendChild(option);
								employmentStatusSelect.value = pwdData.employment_status;
							}
							
							document.getElementById('editEmploymentCategory').value = pwdData.employment_category || '';
							
							// Employment Type - use original value
							const employmentTypeSelect = document.getElementById('editEmploymentType');
							employmentTypeSelect.value = pwdData.employment_type || '';
							// If value doesn't exist in options, add it
							if (pwdData.employment_type && !Array.from(employmentTypeSelect.options).some(opt => opt.value === pwdData.employment_type)) {
								const option = document.createElement('option');
								option.value = pwdData.employment_type;
								option.textContent = pwdData.employment_type;
								employmentTypeSelect.appendChild(option);
								employmentTypeSelect.value = pwdData.employment_type;
							}
							
							// Show/hide employment details based on status
							const employmentDetails = document.getElementById('editEmploymentDetails');
							if (pwdData.employment_status === 'Employee') {
								employmentDetails.style.display = 'block';
							} else {
								employmentDetails.style.display = 'none';
							}
							
							// Populate disability checkboxes - handle different possible formats
							let disabilityArray = [];
							if (Array.isArray(pwdData.disability)) {
								disabilityArray = pwdData.disability;
							} else if (pwdData.disability) {
								disabilityArray = [pwdData.disability];
							}
							
							// Map old disability names to new ones if needed
							const disabilityMapping = {
								'Hard of Hearing/Deaf': 'Deaf or Hard of Hearing',
								'Visual/Blind': 'Visual Disability',
								'Speech/Language Impairment': 'Speech and Language Impairment',
								'Learning Disability': 'Learning Disability',
								'Mental/Intellectual': 'Intellectual Disability',
								'Physical Disability': 'Physical Disability (Orthopedic)',
								'Psychosocial Disability': 'Psychosocial Disability',
								'Cancer': 'Cancer (RA11215)',
								'Rare Disease': 'Rare Disease (RA10747)',
								'Multiple Disability': 'Multiple Disability',
								'Other': 'Other'
							};
							
							disabilityArray = disabilityArray.map(d => disabilityMapping[d] || d);
							
							populateDisabilityCheckboxes('editDisabilityTypes', disabilityTypes, disabilityArray, pwdData.disability_other_text);
							
							// Populate disability causes checkboxes
							let causeArray = [];
							if (Array.isArray(pwdData.cause_disability)) {
								causeArray = pwdData.cause_disability;
							} else if (pwdData.cause_disability) {
								causeArray = [pwdData.cause_disability];
							}
							
							populateDisabilityCheckboxes('editDisabilityCauses', disabilityCauses, causeArray, pwdData.cause_other_text);
							
							// Show the modal
							$('#editModal').modal('show');
							
						} catch (e) {
							console.error('Error parsing edit PWD data:', e);
							alert('Error loading PWD data: ' + e.message);
						}
					});
				});

				// UPDATE BUTTON EVENT HANDLER
				const updatePwdBtn = document.getElementById('updatePwdBtn');
				if (updatePwdBtn) {
					updatePwdBtn.addEventListener('click', async function() {
						const btn = this;
						const form = document.getElementById('editPwdForm');
						
						if (!form) {
							alert('Form not found');
							return;
						}
						
						// Validate form
						if (!form.checkValidity()) {
							form.reportValidity();
							return;
						}
						
						// Prevent multiple clicks
						if (btn.dataset.updating === '1') return;
						btn.dataset.updating = '1';
						
						const originalText = btn.innerHTML;
						btn.disabled = true;
						btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Updating...';
						
						try {
							// Collect form data
							const formData = new FormData(form);
							const updateData = {
								pwd_id: document.getElementById('editPwdId').value,
								// Add edit tracking information (will be overridden by backend session for security)
								edited_by: '<%= (user && user.email) ? user.email : "Unknown" %>',
								edited_at: new Date().toISOString()
							};
							
							// Add all form fields
							for (const [key, value] of formData.entries()) {
								if (key === 'disability[]' || key === 'cause_disability[]') {
									// Handle array fields
									if (!updateData[key.replace('[]', '')]) {
										updateData[key.replace('[]', '')] = [];
									}
									updateData[key.replace('[]', '')].push(value);
								} else {
									updateData[key] = value;
								}
							}
							
							// Get disability checkboxes
							const disabilityCheckboxes = document.querySelectorAll('#editDisabilityTypes input[type="checkbox"]:checked');
							updateData.disability = Array.from(disabilityCheckboxes).map(cb => cb.value);
							
							// Get disability other text
							const disabilityOtherText = document.querySelector('#editDisabilityTypes input[name="disability_other_text"]');
							if (disabilityOtherText && updateData.disability.includes('Other')) {
								updateData.disability_other_text = disabilityOtherText.value || null;
							} else {
								updateData.disability_other_text = null;
							}
							
							// Get cause checkboxes
							const causeCheckboxes = document.querySelectorAll('#editDisabilityCauses input[type="checkbox"]:checked');
							updateData.cause_disability = Array.from(causeCheckboxes).map(cb => cb.value);
							
							// Get cause other text
							const causeOtherText = document.querySelector('#editDisabilityCauses input[name="cause_other_text"]');
							if (causeOtherText && updateData.cause_disability.includes('Other')) {
								updateData.cause_other_text = causeOtherText.value || null;
							} else {
								updateData.cause_other_text = null;
							}
							
							// Calculate age from birthday if needed
							if (updateData.birthday && !updateData.age) {
								const birthday = new Date(updateData.birthday);
								const today = new Date();
								let age = today.getFullYear() - birthday.getFullYear();
								const monthDiff = today.getMonth() - birthday.getMonth();
								if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthday.getDate())) {
									age--;
								}
								updateData.age = age;
							}
							
							// Show/hide spouse name based on civil status
							if (updateData.civil_status !== 'Married') {
								updateData.spouse_name = null;
							}
							
							// Show/hide employment details based on status
							if (updateData.employment_status !== 'Employee') {
								updateData.employment_category = null;
								updateData.employment_type = null;
							}
							
							// Send update request
							const response = await fetch('/update-pwd', {
								method: 'POST',
								headers: {
									'Content-Type': 'application/json'
								},
								body: JSON.stringify(updateData)
							});
							
							const data = await response.json();
							
							if (data.success) {
								alert('PWD record updated successfully!');
								$('#editModal').modal('hide');
								// Reload page to show updated data
								window.location.reload();
							} else {
								alert('Error: ' + (data.message || 'Failed to update record'));
								btn.disabled = false;
								btn.innerHTML = originalText;
								delete btn.dataset.updating;
							}
							
						} catch (error) {
							console.error('Error updating PWD:', error);
							alert('An error occurred while updating the record. Please try again.');
							btn.disabled = false;
							btn.innerHTML = originalText;
							delete btn.dataset.updating;
						}
					});
				}

				// Add dynamic behavior to edit modal
				// Auto-calculate age when birthday changes
				const editBirthdayInput = document.getElementById('editBirthday');
				if (editBirthdayInput) {
					editBirthdayInput.addEventListener('change', function() {
						const birthday = new Date(this.value);
						if (!isNaN(birthday.getTime())) {
							const today = new Date();
							let age = today.getFullYear() - birthday.getFullYear();
							const monthDiff = today.getMonth() - birthday.getMonth();
							if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthday.getDate())) {
								age--;
							}
							document.getElementById('editAge').value = age;
						}
					});
				}
				
				// Show/hide spouse field based on civil status
				const editCivilStatusSelect = document.getElementById('editCivilStatus');
				if (editCivilStatusSelect) {
					editCivilStatusSelect.addEventListener('change', function() {
						const spouseRow = document.getElementById('editSpouseRow');
						if (this.value === 'Married') {
							spouseRow.style.display = 'block';
						} else {
							spouseRow.style.display = 'none';
							document.getElementById('editSpouseName').value = '';
						}
					});
				}
				
				// Show/hide employment details based on employment status
				const editEmploymentStatusSelect = document.getElementById('editEmploymentStatus');
				if (editEmploymentStatusSelect) {
					editEmploymentStatusSelect.addEventListener('change', function() {
						const employmentDetails = document.getElementById('editEmploymentDetails');
						if (this.value === 'Employee') {
							employmentDetails.style.display = 'block';
						} else {
							employmentDetails.style.display = 'none';
							document.getElementById('editEmploymentCategory').value = '';
							document.getElementById('editEmploymentType').value = '';
						}
					});
				}
				
				// Add cleanup handler for edit modal to remove backdrop
				$('#editModal').on('hidden.bs.modal', function () {
					// Remove any leftover backdrop elements
					$('.modal-backdrop').remove();
					// Remove modal-open class from body
					$('body').removeClass('modal-open');
					// Remove inline styles that might block interaction
					$('body').css('padding-right', '');
				});

				// SMS Functionality
				// Character counter for SMS message
				function updateCharCount() {
					const smsMessage = document.getElementById('smsMessage');
					const charCount = document.getElementById('charCount');
					if (smsMessage && charCount) {
						const count = smsMessage.value.length;
						charCount.textContent = count;
						if (count > 160) {
							charCount.style.color = 'red';
						} else {
							charCount.style.color = '';
						}
					}
				}

				const smsMessage = document.getElementById('smsMessage');
				if (smsMessage) {
					smsMessage.addEventListener('input', updateCharCount);
					updateCharCount(); // Initial count
				}

				// Attach SMS handler and modal logic
				(function() {
					const sendBtn = document.getElementById('sendSmsBtn');
					const recipientsListEl = document.getElementById('recipientsList');
					const openSmsBtn = document.getElementById('openSmsForSelected');

					if (sendBtn) {
						sendBtn.addEventListener('click', async function() {
							const btn = this;
							
							// Prevent multiple simultaneous sends
							if (btn.dataset.sending === '1') return;
							btn.dataset.sending = '1';

							const originalText = btn.innerHTML;
							const messageEl = document.getElementById('smsMessage');
							const message = messageEl ? messageEl.value.trim() : '';
							const recipients = recipientsListEl ? Array.from(recipientsListEl.querySelectorAll('.recipient-item')).map(el => ({
								phone: el.dataset.phone,
								name: el.dataset.name,
								first_name: el.dataset.firstName || '',
								middle_name: el.dataset.middleName || '',
								last_name: el.dataset.lastName || '',
								barangay: el.dataset.barangay || '',
								purok: el.dataset.purok || '',
								record_id: el.dataset.recordId || '',
								recipient_type: 'PWD'
							})) : [];

							// Validation
							if (!message) {
								delete btn.dataset.sending;
								alert('Please enter a message');
								return;
							}
							if (!recipients.length) {
								delete btn.dataset.sending;
								alert('No recipients selected');
								return;
							}

							// UI feedback
							btn.setAttribute('disabled', 'disabled');
							btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Sending...';

							try {
								const resp = await fetch('/send-sms', {
									method: 'POST',
									headers: { 'Content-Type': 'application/json' },
									body: JSON.stringify({ recipients, message })
								});

								// Check HTTP status first
								if (!resp.ok) {
									throw new Error(`HTTP error! status: ${resp.status}`);
								}

								// Try to parse JSON response
								let data = null;
								try {
									data = await resp.json();
								} catch (jsonErr) {
									console.warn('Invalid JSON response from server:', jsonErr);
									// Even if JSON parsing fails, if we got 200, consider it success
									alert('SMS has been sent successfully!');
									closeModalAndReset();
									return;
								}

								// Check for success in response data
								if (data && data.success === true) {
									alert('SMS has been sent successfully!');
									console.log('SMS results:', data.results);
									closeModalAndReset();
								} else {
									// Server returned success: false or no success property
									const errorMsg = data && data.error ? data.error : 'SMS sending failed';
									console.error('SMS service reported failure:', errorMsg);
									alert('Failed to send SMS: ' + errorMsg);
								}

							} catch (err) {
								console.error('Error sending SMS:', err);
								// Only show service down message for network errors or server errors
								if (err.message.includes('HTTP error') || err.name === 'TypeError') {
									alert('The SMS service is down at the moment, sorry. Please try again later.');
								} else {
									alert('An unexpected error occurred: ' + err.message);
								}
							} finally {
								// Always clean up
								delete btn.dataset.sending;
								btn.removeAttribute('disabled');
								btn.innerHTML = originalText;
							}
						});
					}

					function closeModalAndReset() {
						// Close modal
						const modalEl = document.getElementById('assistanceModal');
						if (modalEl && typeof bootstrap !== 'undefined' && bootstrap.Modal) {
							const modal = bootstrap.Modal.getInstance(modalEl);
							if (modal) modal.hide();
						} else if (typeof $ !== 'undefined' && $.fn.modal) {
							$('#assistanceModal').modal('hide');
						} else {
							modalEl.style.display = 'none';
							modalEl.classList.remove('show');
						}

						// Reset form
						const form = document.getElementById('smsForm');
						if (form) form.reset();
						updateCharCount();
					}

					// Open SMS modal for selected rows
					if (openSmsBtn && recipientsListEl) {
						function refreshOpenSmsState() {
							const anyChecked = Array.from(document.querySelectorAll('.row-checkbox')).some(cb => cb.checked);
							openSmsBtn.disabled = !anyChecked;
						}

						openSmsBtn.addEventListener('click', function() {
							const selected = Array.from(document.querySelectorAll('.row-checkbox:checked'));
							recipientsListEl.innerHTML = '';

							if (!selected.length) {
								recipientsListEl.innerHTML = '<em>No recipients selected</em>';
								return;
							}

							selected.forEach(cb => {
								const phone = cb.dataset.phone || cb.getAttribute('data-phone') || '';
								const name = cb.dataset.name || cb.getAttribute('data-name') || '';

								// Only add if phone number exists
								if (phone) {
									const item = document.createElement('div');
									item.className = 'recipient-item';
									item.dataset.phone = phone;
									item.dataset.name = name;
									item.dataset.firstName = cb.dataset.firstName || cb.getAttribute('data-first-name') || '';
									item.dataset.middleName = cb.dataset.middleName || cb.getAttribute('data-middle-name') || '';
									item.dataset.lastName = cb.dataset.lastName || cb.getAttribute('data-last-name') || '';
									item.dataset.barangay = cb.dataset.barangay || cb.getAttribute('data-barangay') || '';
									item.dataset.purok = cb.dataset.purok || cb.getAttribute('data-purok') || '';
									item.dataset.recordId = cb.dataset.recordId || cb.getAttribute('data-record-id') || cb.value;
									item.style.padding = '4px 6px';
									item.style.borderBottom = '1px solid #f1f1f1';
									item.innerHTML = `<strong>${name}</strong> <span class="text-muted">${phone}</span>`;
									recipientsListEl.appendChild(item);
								}
							});

							// Show modal
							const modalEl = document.getElementById('assistanceModal');
							if (modalEl && typeof bootstrap !== 'undefined' && bootstrap.Modal) {
								const modal = new bootstrap.Modal(modalEl);
								modal.show();
							} else if (typeof $ !== 'undefined' && $.fn.modal) {
								$('#assistanceModal').modal('show');
							} else {
								modalEl.style.display = 'block';
								modalEl.classList.add('show');
								document.body.classList.add('modal-open');
								const backdrop = document.createElement('div');
								backdrop.className = 'modal-backdrop fade show';
								document.body.appendChild(backdrop);
							}
						});

						// Watch row checkboxes to enable/disable openSmsBtn
						document.querySelectorAll('.row-checkbox').forEach(cb => cb.addEventListener('change', refreshOpenSmsState));
						refreshOpenSmsState();
					}
				})();

				// Reset form when modal is closed
				const assistanceModalEl = document.getElementById('assistanceModal');
				if (assistanceModalEl) {
					assistanceModalEl.addEventListener('hidden.bs.modal', function () {
						const form = document.getElementById('smsForm');
						if (form) form.reset();
						updateCharCount();
					});
				}

				// SMS HISTORY FUNCTIONALITY
				let allSmsHistoryData = []; // Store all SMS history data
				const viewSmsHistoryBtn = document.getElementById('viewSmsHistoryBtn');
				const smsHistoryBarangayFilter = document.getElementById('smsHistoryBarangayFilter');
				const smsHistoryPurokFilter = document.getElementById('smsHistoryPurokFilter');
				
				// Function to render SMS history table
				function renderSmsHistoryTable(data) {
					const tableBody = document.getElementById('smsHistoryTableBody');
					
					if (!data || data.length === 0) {
						tableBody.innerHTML = '<tr><td colspan="7" class="text-center">No SMS history found</td></tr>';
						return;
					}
					
					tableBody.innerHTML = '';
					data.forEach(record => {
						const row = document.createElement('tr');
						const sentDate = new Date(record.sent_at);
						const fullName = `${record.first_name || ''} ${record.middle_name || ''} ${record.last_name || ''}`.trim();
						const statusBadge = record.status === 'sent' 
							? '<span class="badge badge-success">Sent</span>'
							: record.status === 'error'
							? '<span class="badge badge-danger">Error</span>'
							: '<span class="badge badge-warning">Skipped</span>';
						
						row.innerHTML = `
							<td>${sentDate.toLocaleString()}</td>
							<td>${record.phone_number || 'N/A'}</td>
							<td>${fullName || 'N/A'}</td>
							<td>${record.barangay || 'N/A'}</td>
							<td>${record.purok || 'N/A'}</td>
							<td style="max-width: 300px; min-width: 200px; word-wrap: break-word; overflow-wrap: break-word; white-space: normal; line-height: 1.4;">${record.message || 'N/A'}</td>
							<td>${statusBadge}</td>
						`;
						tableBody.appendChild(row);
					});
				}
				
				// Function to filter SMS history
				function filterSmsHistory() {
					const selectedBarangay = smsHistoryBarangayFilter.value;
					const selectedPurok = smsHistoryPurokFilter.value;
					
					let filteredData = allSmsHistoryData;
					
					if (selectedBarangay) {
						filteredData = filteredData.filter(record => record.barangay === selectedBarangay);
					}
					
					if (selectedPurok && selectedPurok !== 'all') {
						filteredData = filteredData.filter(record => record.purok === selectedPurok);
					}
					
					renderSmsHistoryTable(filteredData);
				}
				
				// Barangay filter change handler
				if (smsHistoryBarangayFilter) {
					smsHistoryBarangayFilter.addEventListener('change', function() {
						const selectedBarangay = this.value;
						smsHistoryPurokFilter.innerHTML = '';
						
						const defaultOption = document.createElement('option');
						defaultOption.value = '';
						defaultOption.textContent = 'Select Purok';
						smsHistoryPurokFilter.appendChild(defaultOption);
						
						smsHistoryPurokFilter.disabled = !selectedBarangay;
						
						if (selectedBarangay && barangaysData[selectedBarangay]) {
							const allOption = document.createElement('option');
							allOption.value = 'all';
							allOption.textContent = 'All Puroks';
							smsHistoryPurokFilter.appendChild(allOption);
							
							barangaysData[selectedBarangay].forEach(purok => {
								const option = document.createElement('option');
								option.value = purok;
								option.textContent = purok;
								smsHistoryPurokFilter.appendChild(option);
							});
						}
						
						filterSmsHistory();
					});
				}
				
				// Purok filter change handler
				if (smsHistoryPurokFilter) {
					smsHistoryPurokFilter.addEventListener('change', function() {
						filterSmsHistory();
					});
				}
				
				if (viewSmsHistoryBtn) {
					viewSmsHistoryBtn.addEventListener('click', async function() {
						const modalEl = document.getElementById('smsHistoryModal');
						const tableBody = document.getElementById('smsHistoryTableBody');
						
						// Reset filters
						if (smsHistoryBarangayFilter) {
							smsHistoryBarangayFilter.value = '';
						}
						if (smsHistoryPurokFilter) {
							smsHistoryPurokFilter.innerHTML = '<option value="">First select a Barangay</option>';
							smsHistoryPurokFilter.disabled = true;
						}
						
						// Show modal
						if (typeof $ !== 'undefined' && $.fn.modal) {
							$('#smsHistoryModal').modal('show');
						} else if (modalEl && typeof bootstrap !== 'undefined' && bootstrap.Modal) {
							const modal = new bootstrap.Modal(modalEl);
							modal.show();
						}
						
						// Show loading
						tableBody.innerHTML = '<tr><td colspan="7" class="text-center">Loading...</td></tr>';
						
						try {
							const response = await fetch('/sms-history?recipient_type=PWD&limit=200');
							const data = await response.json();
							
							if (data.success && data.data) {
								allSmsHistoryData = data.data; // Store all data
								renderSmsHistoryTable(allSmsHistoryData);
							} else {
								tableBody.innerHTML = '<tr><td colspan="7" class="text-center text-danger">Error loading SMS history</td></tr>';
							}
						} catch (error) {
							console.error('Error loading SMS history:', error);
							tableBody.innerHTML = '<tr><td colspan="7" class="text-center text-danger">Error loading SMS history</td></tr>';
						}
					});
				}

				// ARCHIVE FUNCTIONALITY
				const archiveButtons = document.querySelectorAll('.archive-btn');
				archiveButtons.forEach(button => {
					button.addEventListener('click', async function() {
						const pwdId = this.getAttribute('data-pwd-id');
						const currentStatus = this.getAttribute('data-status');
						const isArchived = currentStatus === 'Archived';
						
						if (!pwdId) {
							alert('Error: PWD ID not found');
							return;
						}

						// Confirm action
						const action = isArchived ? 'unarchive' : 'archive';
						const confirmMessage = isArchived 
							? 'Are you sure you want to unarchive this PWD record?'
							: 'Are you sure you want to archive this PWD record?';
						
						if (!confirm(confirmMessage)) {
							return;
						}

						// Disable button during request
						const originalHTML = this.innerHTML;
						this.disabled = true;
						this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';

						try {
							const endpoint = isArchived ? '/unarchive-pwd' : '/archive-pwd';
							const response = await fetch(endpoint, {
								method: 'POST',
								headers: {
									'Content-Type': 'application/json'
								},
								body: JSON.stringify({ pwd_id: pwdId })
							});

							const data = await response.json();

							if (data.success) {
								alert(data.message || `PWD record ${action}d successfully`);
								// Reload the page to reflect the changes
								window.location.reload();
							} else {
								alert('Error: ' + (data.message || 'Failed to ' + action + ' record'));
								this.disabled = false;
								this.innerHTML = originalHTML;
							}
						} catch (error) {
							console.error('Archive error:', error);
							alert('An error occurred while ' + action + 'ing the record. Please try again.');
							this.disabled = false;
							this.innerHTML = originalHTML;
						}
					});
				});
			});

			// Initialize Feather Icons
			if (typeof feather !== 'undefined' && feather.replace) {
				try {
					feather.replace();
				} catch (e) {
					console.warn('feather.replace() failed:', e);
				}
			} else {
				console.warn('feather not available');
			}
		</script>
		<!-- Required Jquery -->
		<script type="text/javascript" src="\bower_components\jquery\js\jquery.min.js"></script>
		<script type="text/javascript" src="\bower_components\jquery-ui\js\jquery-ui.min.js"></script>
		<script type="text/javascript" src="\bower_components\popper.js\js\popper.min.js"></script>
		<script type="text/javascript" src="\bower_components\bootstrap\js\bootstrap.min.js"></script>
		<!-- DataTables JS -->
		<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
		<!-- Other scripts -->
		<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.1/chart.min.js"></script>
		<script type="text/javascript" src="\bower_components\jquery-slimscroll\js\jquery.slimscroll.js"></script>
		<script type="text/javascript" src="\bower_components\modernizr\js\modernizr.js"></script>
		<script type="text/javascript" src="\bower_components\modernizr\js\css-scrollbars.js"></script>
		<script type="text/javascript" src="\bower_components\chart.js\js\Chart.js"></script>
		<script src="\assets\pages\widget\amchart\amcharts.js"></script>
		<script src="\assets\pages\widget\amchart\serial.js"></script>
		<script src="\assets\pages\widget\amchart\light.js"></script>
		<script type="text/javascript" src="\assets\js\SmoothScroll.js"></script>
		<script src="\assets\js\pcoded.min.js"></script>
		<script src="\assets\js\jquery.mCustomScrollbar.concat.min.js"></script>
		<script src="\assets\js\vartical-layout.min.js"></script>
		<script type="text/javascript" src="\assets\pages\dashboard\analytic-dashboard.min.js"></script>
		<script type="text/javascript" src="\assets\js\script.js"></script>
		<script type="text/javascript" src="\assets\js\senior.js"></script>
		<!-- Global site tag (gtag.js) - Google Analytics -->
		<script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-23581568-13"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/feather-icons/4.29.0/feather.min.js"></script>
    <script>
		window.dataLayer = window.dataLayer || [];

		function gtag() {
			dataLayer.push(arguments);
		}
		gtag('js', new Date());
		gtag('config', 'UA-23581568-13');
		</script>
	</body>
</html>